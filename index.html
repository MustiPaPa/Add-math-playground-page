<!DOCTYPE html>
<html lang="so">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Musti ‚Äì Lern-Spielplatz</title>
<style>
    * { box-sizing: border-box; }

    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #84c0f0, #f7f9ff);
        text-align: center;
        color: #123;
        transition: background 0.3s, color 0.3s;
    }

    body.dark {
        background: radial-gradient(circle at top, #1f2937, #020617);
        color: #e5e7eb;
    }

    header {
        position: relative;
        padding: 18px 10px 12px;
        color: white;
        font-size: 24px;
        font-weight: bold;
        background: linear-gradient(90deg, #004f9f, #0099ff);
        box-shadow: 0 3px 8px rgba(0,0,0,0.25);
    }
    body.dark header {
        background: linear-gradient(90deg, #0f172a, #1d4ed8);
    }

    header small {
        display: block;
        font-size: 13px;
        margin-top: 5px;
        opacity: 0.9;
    }
    .header-flags {
        position: absolute;
        top: 8px;
        right: 10px;
        display: flex;
        gap: 8px;
        font-size: 26px;
        align-items: center;
    }
    .header-flags span.flag-circle {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 34px;
        height: 34px;
        border-radius: 50%;
        box-shadow: 0 0 0 2px rgba(255,255,255,0.9);
        background: rgba(0,0,0,0.15);
    }
    .dark-toggle-btn {
        padding: 4px 10px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        font-size: 11px;
        margin-right: 6px;
        background: rgba(255,255,255,0.9);
        color: #111827;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    body.dark .dark-toggle-btn {
        background: rgba(15,23,42,0.9);
        color: #e5e7eb;
        border: 1px solid #4b5563;
    }

    .top-wrap {
        max-width: 1100px;
        margin: 10px auto 0;
        padding: 0 10px 5px;
        display: grid;
        grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.5fr);
        gap: 10px;
    }
    @media (max-width: 900px) {
        .top-wrap { grid-template-columns: minmax(0,1fr); }
    }

    .top-bar, .profile-panel {
        background: rgba(255,255,255,0.94);
        border-radius: 12px;
        padding: 8px 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
        text-align: left;
    }
    body.dark .top-bar,
    body.dark .profile-panel {
        background: rgba(15,23,42,0.95);
        box-shadow: 0 2px 10px rgba(0,0,0,0.6);
    }

    .top-bar-row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 8px;
    }
    .top-bar input[type="text"] {
        padding: 5px 8px;
        border-radius: 8px;
        border: 1px solid #cbd5e1;
        min-width: 130px;
        font-size: 13px;
    }
    body.dark .top-bar input[type="text"] {
        background: #020617;
        color: #e5e7eb;
        border-color: #475569;
    }

    .top-bar .score {
        font-weight: bold;
        padding: 2px 8px;
        border-radius: 10px;
        background: #1b75d0;
        color: #fff;
    }
    .top-bar small {
        font-size: 11px;
        opacity: 0.8;
    }

    .profile-panel h3 { margin: 0 0 6px; font-size: 15px; }

    .profile-form {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        align-items: center;
        margin-bottom: 6px;
    }
    .profile-form input,
    .profile-form select {
        padding: 5px 8px;
        border-radius: 8px;
        border: 1px solid #cbd5e1;
        font-size: 13px;
    }
    body.dark .profile-form input,
    body.dark .profile-form select {
        background: #020617;
        border-color: #475569;
        color: #e5e7eb;
    }
    .profile-form button {
        padding: 5px 10px;
        border-radius: 10px;
        border: none;
        background: #22c55e;
        color: white;
        font-weight: bold;
        cursor: pointer;
        font-size: 12px;
    }
    .profile-form button:hover { background: #16a34a; }

    .profile-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-top: 5px;
    }
    .profile-btn {
        border-radius: 999px;
        padding: 4px 10px;
        border: none;
        font-size: 12px;
        cursor: pointer;
        background: #e5e7eb;
    }
    .profile-btn.active {
        background: #1d4ed8;
        color: white;
        font-weight: bold;
    }
    body.dark .profile-btn {
        background: #111827;
        color: #e5e7eb;
    }
    body.dark .profile-btn.active {
        background: #1d4ed8;
    }

    .hall-of-fame {
        margin-top: 6px;
        font-size: 11px;
        max-height: 180px;
        overflow: auto;
    }
    .hall-of-fame table {
        width: 100%;
        border-collapse: collapse;
    }
    .hall-of-fame th,
    .hall-of-fame td {
        border-bottom: 1px solid #e5e7eb;
        padding: 2px 3px;
        text-align: left;
        white-space: nowrap;
    }
    .hall-of-fame th {
        background: #e5edff;
        position: sticky;
        top: 0;
        z-index: 1;
    }
    body.dark .hall-of-fame th {
        background: #111827;
    }
    body.dark .hall-of-fame td {
        border-bottom-color: #1f2937;
    }

    .layout-main {
        max-width: 1100px;
        margin: 10px auto 20px;
        padding: 0 10px;
        display: grid;
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
        gap: 12px;
    }
    @media (max-width: 900px) {
        .layout-main { grid-template-columns: minmax(0,1fr); }
    }

    .game-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
        padding: 10px 0;
    }

    .card {
        background: white;
        border-radius: 14px;
        padding: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.23);
        cursor: pointer;
        transition: 0.18s;
        text-align: center;
    }
    body.dark .card {
        background: #020617;
        box-shadow: 0 4px 12px rgba(0,0,0,0.7);
    }
    .card:hover {
        transform: translateY(-2px);
        background: #e0efff;
    }
    body.dark .card:hover {
        background: #111827;
    }

    .card .emoji { font-size: 32px; }
    .card .title { font-size: 15px; font-weight: bold; margin-top: 6px; }
    .card .sub { font-size: 11px; color: #555; }
    body.dark .card .sub { color: #9ca3af; }

    .game-area {
        background: #ffffff;
        border-radius: 15px;
        padding: 15px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        text-align: left;
        min-height: 260px;
    }
    body.dark .game-area {
        background: #020617;
        box-shadow: 0 4px 14px rgba(0,0,0,0.8);
    }

    .game-area-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
    }
    .game-area h2 {
        margin-top: 0;
        margin-bottom: 6px;
    }
    .back-btn {
        padding: 4px 10px;
        font-size: 11px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        background: #e5e7eb;
    }
    body.dark .back-btn {
        background: #111827;
        color: #e5e7eb;
        border: 1px solid #374151;
    }
    .back-btn:hover {
        background: #d1d5db;
    }
    body.dark .back-btn:hover {
        background: #1f2937;
    }

    .question {
        font-size: 18px;
        margin: 8px 0;
        white-space: pre-line;
    }
    .hint {
        font-size: 12px;
        color: #555;
        margin-bottom: 4px;
        white-space: pre-line;
    }
    body.dark .hint { color: #9ca3af; }

    .options {
        margin-top: 6px;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    .option-btn {
        padding: 8px 12px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        text-align: left;
        font-size: 14px;
        font-weight: 500;
        background: #e0f2fe;
        color: #0f172a;
        box-shadow: 0 1px 4px rgba(15,23,42,0.25);
        transition: transform 0.1s, box-shadow 0.1s, background 0.1s;
    }
    .option-btn:nth-child(2) { background: #fef3c7; }
    .option-btn:nth-child(3) { background: #e5e7eb; }
    .option-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(15,23,42,0.35);
    }
    body.dark .option-btn {
        background: #1f2937;
        color: #e5e7eb;
        box-shadow: 0 1px 6px rgba(0,0,0,0.8);
    }
    body.dark .option-btn:nth-child(2) { background: #312e81; }
    body.dark .option-btn:nth-child(3) { background: #064e3b; }

    .feedback {
        margin-top: 8px;
        font-weight: bold;
    }

    .side-info {
        background: #fffbcc;
        border-radius: 12px;
        padding: 10px 12px;
        font-size: 12px;
        text-align: left;
        box-shadow: 0 3px 8px rgba(0,0,0,0.18);
    }
    body.dark .side-info {
        background: #111827;
        color: #e5e7eb;
        box-shadow: 0 3px 10px rgba(0,0,0,0.8);
    }
    .side-info h3 { margin-top: 0; }
    .side-info ul {
        padding-left: 18px;
        margin: 5px 0 8px;
    }
</style>
</head>
<body>

<header>
  Musti ‚Äì Lern-Spielplatz f√ºr Kinder
  <small>Mathe ¬∑ Deutsch ¬∑ Englisch ¬∑ Franz√∂sisch ¬∑ Informatik ¬∑ Somalia ¬∑ Schweiz ¬∑ CCNA</small>
  <div class="header-flags">
      <button class="dark-toggle-btn" onclick="toggleDarkMode()">
          <span id="darkIcon">üåô</span> <span id="darkText">Dark</span>
      </button>
      <span class="flag-circle" title="Schweiz">üá®üá≠</span>
      <span class="flag-circle" title="Somalia">üá∏üá¥</span>
  </div>
</header>

<div class="top-wrap">
    <div class="top-bar">
        <div class="top-bar-row">
            <label style="font-size:12px;">Desktop-Name / Magaca PC:</label>
            <input type="text" id="pcName" placeholder="z.B. Musti-PC" oninput="updatePcNameTitle()" />
            <span class="score" id="scoreBox">Score: 0</span>
        </div>
        <small>
            1) Dooro ilmuhu & fasalkiisa (rechts). 2) Markaas dooro Spiel (hoos). 3) Jawaabo guji.
            Hadaf maalinle: qiyaastii 20 su'aal (~15‚Äì20 min).
        </small>
    </div>

    <div class="profile-panel">
        <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Kinder-Profile / Carruurta</h3>
        <div class="profile-form">
            <input type="text" id="childName" placeholder="Magaca ilmaha" />
            <select id="childGrade">
                <option value="1">Klasse 1</option>
                <option value="2">Klasse 2</option>
                <option value="3">Klasse 3</option>
                <option value="4">Klasse 4</option>
                <option value="5">Klasse 5</option>
                <option value="6">Klasse 6</option>
                <option value="special">Spezial 6/7</option>
            </select>
            <button onclick="addProfile()">Speichern / Save</button>
        </div>
        <div class="profile-buttons" id="profileButtons"></div>
        <div class="hall-of-fame" id="hallOfFame"></div>
    </div>
</div>

<div class="layout-main">
    <div>
        <div class="game-grid" id="gameGrid">
            <div class="card" onclick="chooseMode('add')">
                <div class="emoji">‚ûï</div>
                <div class="title">Addition</div>
                <div class="sub">1‚Äì20 ¬∑ 3 Antworten</div>
            </div>
            <div class="card" onclick="chooseMode('sub')">
                <div class="emoji">‚ûñ</div>
                <div class="title">Subtraktion</div>
                <div class="sub">Ka-jarid ¬∑ 1‚Äì30</div>
            </div>
            <div class="card" onclick="chooseMode('mul')">
                <div class="emoji">‚úñÔ∏è</div>
                <div class="title">Multiplikation</div>
                <div class="sub">2er‚Äì10er Reihe</div>
            </div>
            <div class="card" onclick="chooseMode('frac')">
                <div class="emoji">üß©</div>
                <div class="title">Br√ºche</div>
                <div class="sub">1/2, 1/3, 1/4 ...</div>
            </div>
            <div class="card" onclick="chooseMode('de')">
                <div class="emoji">üá©üá™</div>
                <div class="title">Deutsch Rechnen</div>
                <div class="sub">‚ÄûWie viel ist 3 + 5?‚Äú</div>
            </div>
            <div class="card" onclick="chooseMode('en')">
                <div class="emoji">üá¨üáß</div>
                <div class="title">English A1‚ÄìB2</div>
                <div class="sub">Conversation + Grammar</div>
            </div>
            <div class="card" onclick="chooseMode('fr')">
                <div class="emoji">üá´üá∑</div>
                <div class="title">Fran√ßais A1‚ÄìB2</div>
                <div class="sub">Conversation + Grammaire</div>
            </div>
            <div class="card" onclick="chooseMode('delang')">
                <div class="emoji">üìò</div>
                <div class="title">Deutsch Grammatik</div>
                <div class="sub">A1‚ÄìB2 S√§tze</div>
            </div>
            <div class="card" onclick="chooseMode('itbasics')">
                <div class="emoji">üíª</div>
                <div class="title">Informatik Basics</div>
                <div class="sub">PC, Komponenten, Outlook</div>
            </div>
            <div class="card" onclick="chooseMode('flags')">
                <div class="emoji">üåç</div>
                <div class="title">Flaggen Afrika</div>
                <div class="sub">Calamo + 3 Antworten</div>
            </div>
            <div class="card" onclick="chooseMode('chgeo')">
                <div class="emoji">üèîÔ∏è</div>
                <div class="title">Schweiz ‚Äì Kantone</div>
                <div class="sub">Wallis, Graub√ºnden, Aargau ...</div>
            </div>
            <div class="card" onclick="chooseMode('soinfo')">
                <div class="emoji">üèñÔ∏è</div>
                <div class="title">Somalia ‚Äì Wissen</div>
                <div class="sub">Gobollo, xeebaha, taariikh</div>
            </div>
            <div class="card" onclick="chooseMode('ccna')">
                <div class="emoji">üß†</div>
                <div class="title">CCNA ‚Äì STP Basics</div>
                <div class="sub">Spanning Tree, Root Bridge, Ports</div>
            </div>
        </div>

        <div class="game-area" id="gameArea" style="margin-top:10px;">
            <div class="game-area-header">
                <h2 id="gameTitle">Spiel w√§hlen / Doorow Spiel</h2>
                <button class="back-btn" id="backBtn" style="display:none;" onclick="backToMenu()">‚¨Ö √úbersicht</button>
            </div>
            <p class="hint" id="instructions">
                Dooro ilmuhu kor, kadibna dooro modul (Mathe, Sprachen, Somalia, Schweiz, CCNA...).
            </p>
            <div class="question" id="questionBox">Frage / Su‚Äôaal ayaa halkan iman doonta.</div>
            <div class="options" id="optionsBox"></div>
            <div class="feedback" id="feedbackBox"></div>
        </div>
    </div>

    <div class="side-info">
        <h3>Deutsch W√∂rter ‚Äì Math</h3>
        <ul>
            <li><b>plus</b> = + (z. B. 3 plus 4)</li>
            <li><b>minus</b> = ‚àí (z. B. 7 minus 2)</li>
            <li><b>mal</b> = √ó (z. B. 3 mal 5)</li>
            <li><b>geteilt durch</b> = √∑ (z. B. 8 geteilt durch 2)</li>
            <li><b>Ergebnis</b> = natiijo / Resultat</li>
        </ul>
        <p>
        Af-Deutsch instructions fudud:<br>
        ‚Äì W√§hle oben ein Spiel. (Kor ka dooro ciyaarta.)<br>
        ‚Äì Lies die Frage. (Akhri su‚Äôaasha.)<br>
        ‚Äì Klick auf eine Antwort. (Guji jawaabta saxda ah.)<br>
        ‚Äì Du siehst sofort: richtig oder falsch. (Isla markiiba waad arkaysaa sax/khalad.)
        </p>
        <p style="font-size:11px;opacity:0.8;">
            Maalin walba hadaf: ~20 su‚Äôaal (15‚Äì20 min). App-ku wuxuu kaydiyaa:  
            ‚Äì Imisa su‚Äôaal oo maanta la qabtay<br>
            ‚Äì Qeybaha uu ilmuhu ku fiican yahay / ku daciif yahay (Mathe, Lesen, Sprachen, Wissen, CCNA).
        </p>
    </div>
</div>

<script>
/* ========= GLOBAL STATE ========= */

var STORAGE_KEY = "musti-lernspielplatz-profiles-v1";
var DARK_KEY = "musti-lernspielplatz-dark";

var profiles = [];
var activeProfileId = null;
var currentMode = null;
var currentQuestion = null;
var score = 0;

/* ========= DARK MODE ========= */

function applyDarkFromStorage() {
    try {
        var val = localStorage.getItem(DARK_KEY);
        if (val === "1") {
            document.body.classList.add("dark");
        }
    } catch(e){}
    updateDarkToggleText();
}

function toggleDarkMode() {
    document.body.classList.toggle("dark");
    try {
        localStorage.setItem(DARK_KEY, document.body.classList.contains("dark") ? "1" : "0");
    } catch(e){}
    updateDarkToggleText();
}

function updateDarkToggleText() {
    var icon = document.getElementById("darkIcon");
    var txt = document.getElementById("darkText");
    if (!icon || !txt) return;
    if (document.body.classList.contains("dark")) {
        icon.textContent = "‚òÄÔ∏è";
        txt.textContent = "Light";
    } else {
        icon.textContent = "üåô";
        txt.textContent = "Dark";
    }
}

/* ========= DAILY HELPERS ========= */

function todayStr() {
    var d = new Date();
    var m = String(d.getMonth() + 1).padStart(2, "0");
    var day = String(d.getDate()).padStart(2, "0");
    return d.getFullYear() + "-" + m + "-" + day;
}

function ensureDaily(profile) {
    if (!profile.daily) {
        profile.daily = {
            date: todayStr(),
            questions: 0
        };
    }
}

/* ========= MODULES INIT ========= */

function ensureModules(profile) {
    if (!profile.modules) profile.modules = {};
    var modes = [
        "add","sub","mul","frac",
        "de",
        "en","fr","delang",
        "itbasics",
        "flags",
        "chgeo",
        "soinfo",
        "ccna"
    ];
    modes.forEach(function(m){
        if (!profile.modules[m]) {
            profile.modules[m] = {
                correct: 0,
                total: 0
            };
        }
    });
}

/* ========= STORAGE ========= */

function saveProfiles() {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(profiles));
    } catch(e) {
        console.warn("localStorage error", e);
    }
}

function loadProfiles() {
    try {
        var raw = localStorage.getItem(STORAGE_KEY);
        profiles = raw ? JSON.parse(raw) : [];
    } catch (e) {
        profiles = [];
    }
    for (var i=0;i<profiles.length;i++){
        ensureModules(profiles[i]);
        ensureDaily(profiles[i]);
    }
    renderProfileButtons();
    renderHallOfFame();
}

/* ========= PROFILE HELPERS ========= */

function addProfile() {
    var name = document.getElementById("childName").value.trim();
    var grade = document.getElementById("childGrade").value;
    if (!name) return;

    var newProfile = {
        id: Date.now(),
        name: name,
        grade: grade,
        score: 0,
        modules: {},
        daily: null
    };
    ensureModules(newProfile);
    ensureDaily(newProfile);

    profiles.push(newProfile);
    activeProfileId = newProfile.id;
    saveProfiles();
    renderProfileButtons();
    renderHallOfFame();
    updateScoreUI();
    document.getElementById("childName").value = "";
}

function getActiveProfile() {
    if (!activeProfileId) return null;
    for (var i=0;i<profiles.length;i++){
        if (profiles[i].id === activeProfileId) return profiles[i];
    }
    return null;
}

function setActiveProfile(id) {
    activeProfileId = id;
    var p = getActiveProfile();
    if (p) {
        score = p.score || 0;
    } else {
        score = 0;
    }
    updateScoreUI();
    renderProfileButtons();
    renderHallOfFame();
    var inst = document.getElementById("instructions");
    if (p) {
        inst.textContent = "Kind: " + p.name + " ¬∑ Bitte Spiel w√§hlen.";
    } else {
        inst.textContent = "Bitte zuerst ein Kind ausw√§hlen.";
    }
}

function renderProfileButtons() {
    var box = document.getElementById("profileButtons");
    box.innerHTML = "";
    profiles.forEach(function(p){
        var btn = document.createElement("button");
        btn.className = "profile-btn" + (p.id === activeProfileId ? " active" : "");
        btn.textContent = p.name + " (Kl. " + (p.grade === "special" ? "6/7" : p.grade) + ")";
        btn.onclick = function(){ setActiveProfile(p.id); };
        box.appendChild(btn);
    });
}

function percentage(corr, tot) {
    return tot > 0 ? Math.round(corr / tot * 100) : 0;
}

function renderHallOfFame() {
    var box = document.getElementById("hallOfFame");
    if (!profiles.length) {
        box.innerHTML = "<em>Noch keine Kinder hinzugef√ºgt.</em>";
        return;
    }
    var html = "<table><thead><tr>" +
        "<th>Kind</th><th>Kl.</th>" +
        "<th>Mathe</th><th>Lesen</th><th>Sprachen</th><th>Wissen+CCNA</th>" +
        "<th>Heute</th>" +
        "</tr></thead><tbody>";
    profiles.forEach(function(p){
        ensureModules(p);
        ensureDaily(p);
        var m = p.modules;

        var matheCorr = m.add.correct + m.sub.correct + m.mul.correct + m.frac.correct;
        var matheTot  = m.add.total   + m.sub.total   + m.mul.total   + m.frac.total;
        var lesenCorr = m.de.correct;
        var lesenTot  = m.de.total;
        var sprCorr   = m.en.correct + m.fr.correct + (m.delang ? m.delang.correct : 0);
        var sprTot    = m.en.total   + m.fr.total   + (m.delang ? m.delang.total   : 0);
        var wCorr     = m.itbasics.correct + m.flags.correct + m.chgeo.correct + m.soinfo.correct + (m.ccna ? m.ccna.correct : 0);
        var wTot      = m.itbasics.total   + m.flags.total   + m.chgeo.total   + m.soinfo.total   + (m.ccna ? m.ccna.total   : 0);

        var mathePct = percentage(matheCorr, matheTot);
        var lesenPct = percentage(lesenCorr, lesenTot);
        var sprPct   = percentage(sprCorr,   sprTot);
        var wPct     = percentage(wCorr,     wTot);

        var today = todayStr();
        var qToday = (p.daily && p.daily.date === today) ? (p.daily.questions || 0) : 0;

        html += "<tr>" +
            "<td>" + escapeHtml(p.name) + "</td>" +
            "<td>" + (p.grade === "special" ? "6/7" : p.grade) + "</td>" +
            "<td>" + mathePct + "%</td>" +
            "<td>" + lesenPct + "%</td>" +
            "<td>" + sprPct + "%</td>" +
            "<td>" + wPct + "%</td>" +
            "<td>" + qToday + "</td>" +
            "</tr>";
    });
    html += "</tbody></table>";
    box.innerHTML = html;
}

/* ========= OTHER HELPERS ========= */

function updatePcNameTitle() {
    var val = document.getElementById("pcName").value.trim();
    if (val) {
        document.title = val + " ‚Äì Musti Lern-Spielplatz";
    } else {
        document.title = "Musti ‚Äì Lern-Spielplatz";
    }
}

function updateScoreUI() {
    document.getElementById("scoreBox").textContent = "Score: " + score;
}

function randomInt(min, max){
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function shuffle(arr) {
    for (var i = arr.length - 1; i > 0; i--) {
        var j = randomInt(0, i);
        var t = arr[i];
        arr[i] = arr[j];
        arr[j] = t;
    }
    return arr;
}

function escapeHtml(str) {
    return String(str)
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;");
}

/* ========= DAILY UPDATE ON ANSWER ========= */

function updateDailyOnAnswer() {
    var p = getActiveProfile();
    if (!p) return;

    ensureDaily(p);

    var today = todayStr();
    if (p.daily.date !== today) {
        p.daily.date = today;
        p.daily.questions = 0;
    }
    p.daily.questions++;
}

/* ========= DAILY MISSION TEXT ========= */

function buildDailyMission(profile) {
    ensureModules(profile);
    ensureDaily(profile);

    var today = todayStr();
    var questionsToday = (profile.daily.date === today) ? (profile.daily.questions || 0) : 0;
    var target = 20;
    var remaining = Math.max(target - questionsToday, 0);

    var m = profile.modules;

    var matheCorr = m.add.correct + m.sub.correct + m.mul.correct + m.frac.correct;
    var matheTot  = m.add.total   + m.sub.total   + m.mul.total   + m.frac.total;
    var lesenCorr = m.de.correct;
    var lesenTot  = m.de.total;
    var sprCorr   = m.en.correct + m.fr.correct + (m.delang ? m.delang.correct : 0);
    var sprTot    = m.en.total   + m.fr.total   + (m.delang ? m.delang.total   : 0);
    var wCorr     = m.itbasics.correct + m.flags.correct + m.chgeo.correct + m.soinfo.correct + (m.ccna ? m.ccna.correct : 0);
    var wTot      = m.itbasics.total   + m.flags.total   + m.chgeo.total   + m.soinfo.total   + (m.ccna ? m.ccna.total   : 0);

    function pct(corr, tot) {
        return tot > 0 ? Math.round(corr / tot * 100) : 0;
    }

    var mathePct = pct(matheCorr, matheTot);
    var lesenPct = pct(lesenCorr, lesenTot);
    var sprPct   = pct(sprCorr,   sprTot);
    var wPct     = pct(wCorr,     wTot);

    var cats = [
        { key: "Mathe", pct: mathePct },
        { key: "Lesen", pct: lesenPct },
        { key: "Sprachen", pct: sprPct },
        { key: "Wissen+CCNA", pct: wPct }
    ];
    cats.sort(function(a,b){ return a.pct - b.pct; });
    var weakest = cats[0];

    var txt = "Maanta: " + questionsToday + "/" + target + " su'aalood.";
    if (remaining > 0) {
        txt += " Waxaa ka hadhay " + remaining + " su'aal si aad u gaarto hadafka maalinlaha.";
    } else {
        txt += " üéâ Hadafkii maanta waad dhammaysay!";
    }

    if (weakest && weakest.pct < 70) {
        txt += " Fokus: " + weakest.key + " (waxaan kor u qaadeynaa qeybtaan).";
    }

    return txt;
}

/* ========= LEVEL HELPERS ========= */

function getProfileLevel(profile, mode) {
    ensureModules(profile);
    var mod = profile.modules[mode];
    if (!mod) return 1;
    var corr = mod.correct || 0;
    return 1 + Math.floor(corr / 5); // 5 sax = level up
}

function getModeLabel(mode) {
    var map = {
        add: "Addition",
        sub: "Subtraktion",
        mul: "Multiplikation",
        frac: "Br√ºche",
        de: "Deutsch Rechnen",
        en: "English",
        fr: "Fran√ßais",
        delang: "Deutsch Grammatik",
        itbasics: "Informatik Basics",
        flags: "Flaggen Afrika",
        chgeo: "Schweiz ‚Äì Kantone",
        soinfo: "Somalia ‚Äì Wissen",
        ccna: "CCNA ‚Äì STP Basics"
    };
    return map[mode] || mode;
}

/* ========= QUESTION BANKS ========= */

/* ENGLISH A1‚ÄìB2 */
var enQuestions = [
    /* A1 */
    {
        level: "A1",
        type: "conversation",
        question: "You meet someone. They say: ‚ÄúHello, how are you?‚Äù\nWhich answer is best?",
        options: [
            "I am fine, thank you.",
            "I cooking.",
            "You are name."
        ],
        correctIndex: 0
    },
    {
        level: "A1",
        type: "conversation",
        question: "You are in a shop and want bread.\nWhat do you say?",
        options: [
            "One bread, please.",
            "I am bread.",
            "Give bread now."
        ],
        correctIndex: 0
    },
    {
        level: "A1",
        type: "grammar",
        question: "Choose the correct sentence:",
        options: [
            "He is my friend.",
            "He are my friend.",
            "He am my friend."
        ],
        correctIndex: 0
    },
    {
        level: "A1",
        type: "grammar",
        question: "Which sentence is correct?",
        options: [
            "I have a dog.",
            "I has a dog.",
            "I having a dog."
        ],
        correctIndex: 0
    },

    /* A2 */
    {
        level: "A2",
        type: "conversation",
        question: "You call a friend: ‚ÄúCan we meet this afternoon?‚Äù\nBest answer:",
        options: [
            "Yes, I am free after 4 o‚Äôclock.",
            "Yes, I free 4.",
            "I tomorrow free."
        ],
        correctIndex: 0
    },
    {
        level: "A2",
        type: "conversation",
        question: "At the doctor: ‚ÄúWhat‚Äôs the problem?‚Äù\nWhat do you say?",
        options: [
            "I have a headache and feel tired.",
            "You have problem.",
            "My head is very interesting."
        ],
        correctIndex: 0
    },
    {
        level: "A2",
        type: "grammar",
        question: "Correct present continuous:",
        options: [
            "She is reading a book.",
            "She reading a book.",
            "She are reading a book."
        ],
        correctIndex: 0
    },
    {
        level: "A2",
        type: "grammar",
        question: "Fill the gap: ‚ÄúI am ______ for a new job.‚Äù",
        options: [
            "looking",
            "look",
            "looked"
        ],
        correctIndex: 0
    },

    /* B1 */
    {
        level: "B1",
        type: "conversation",
        question: "At work: ‚ÄúCan you explain this again?‚Äù\nBest answer:",
        options: [
            "Sure, let me explain it step by step.",
            "No talk today.",
            "I explain but no understand."
        ],
        correctIndex: 0
    },
    {
        level: "B1",
        type: "conversation",
        question: "You missed the train.\nWhat is the most natural sentence?",
        options: [
            "I missed my train, when is the next one?",
            "Train bad, me angry.",
            "Why train go?"
        ],
        correctIndex: 0
    },
    {
        level: "B1",
        type: "grammar",
        question: "Choose the correct past tense sentence:",
        options: [
            "Yesterday I went to the cinema.",
            "Yesterday I go to the cinema.",
            "Yesterday I was go to the cinema."
        ],
        correctIndex: 0
    },
    {
        level: "B1",
        type: "grammar",
        question: "Correct sentence for talking about experience:",
        options: [
            "I have worked in IT for three years.",
            "I am working in IT since three years.",
            "I was work in IT for three years."
        ],
        correctIndex: 0
    },

    /* B2 */
    {
        level: "B2",
        type: "conversation",
        question: "Meeting: ‚ÄúCan you summarize the main point?‚Äù\nBest answer:",
        options: [
            "Yes, the main point is that we need to improve our workflow efficiency.",
            "Yes, main point good.",
            "Summary no."
        ],
        correctIndex: 0
    },
    {
        level: "B2",
        type: "conversation",
        question: "You disagree politely in a meeting.",
        options: [
            "I understand your point, but I see it differently.",
            "You are wrong.",
            "I don‚Äôt like your idea."
        ],
        correctIndex: 0
    },
    {
        level: "B2",
        type: "grammar",
        question: "Choose the best sentence:",
        options: [
            "If I had more time, I would learn another language.",
            "If I will have more time, I learn another language.",
            "If I have more time, I would learn another language (yesterday)."
        ],
        correctIndex: 0
    },
    {
        level: "B2",
        type: "grammar",
        question: "Formal e-mail:\nWhich opening is best?",
        options: [
            "Dear Sir or Madam,",
            "Hey you,",
            "Yo boss,"
        ],
        correctIndex: 0
    }
];

/* FRANZ√ñSISCH A1‚ÄìB2 */
var frQuestions = [
    /* A1 */
    {
        level: "A1",
        type: "conversation",
        question: "Quelle est la meilleure r√©ponse ?\n¬´ Bonjour, √ßa va ? ¬ª",
        options: [
            "√áa va bien, merci.",
            "Je pain.",
            "Tu nom eau."
        ],
        correctIndex: 0
    },
    {
        level: "A1",
        type: "conversation",
        question: "Au magasin : tu veux du pain.\nQue dis-tu ?",
        options: [
            "Un pain, s‚Äôil vous pla√Æt.",
            "Je suis pain.",
            "Donne pain maintenant."
        ],
        correctIndex: 0
    },
    {
        level: "A1",
        type: "grammar",
        question: "Choisis la phrase correcte :",
        options: [
            "Il est mon ami.",
            "Il sont mon ami.",
            "Il es mon ami."
        ],
        correctIndex: 0
    },
    {
        level: "A1",
        type: "grammar",
        question: "Quelle phrase est correcte ?",
        options: [
            "J‚Äôai un chien.",
            "Je ai un chien.",
            "Je avoir un chien."
        ],
        correctIndex: 0
    },

    /* A2 */
    {
        level: "A2",
        type: "conversation",
        question: "Tu appelles un ami : ¬´ On peut se voir cet apr√®s-midi ? ¬ª\nMeilleure r√©ponse :",
        options: [
            "Oui, je suis libre apr√®s 16 heures.",
            "Oui, moi libre 16.",
            "Je demain libre."
        ],
        correctIndex: 0
    },
    {
        level: "A2",
        type: "conversation",
        question: "Chez le m√©decin : ¬´ Quel est le probl√®me ? ¬ª\nQue dis-tu ?",
        options: [
            "J‚Äôai mal √† la t√™te et je suis fatigu√©(e).",
            "Tu as probl√®me.",
            "Ma t√™te est tr√®s int√©ressante."
        ],
        correctIndex: 0
    },
    {
        level: "A2",
        type: "grammar",
        question: "Choisis le verbe au pr√©sent correct :\n¬´ Nous ______ au cin√©ma. ¬ª",
        options: [
            "allons",
            "allez",
            "vas"
        ],
        correctIndex: 0
    },
    {
        level: "A2",
        type: "grammar",
        question: "Compl√®te : ¬´ Je suis en train de ______ un livre. ¬ª",
        options: [
            "lire",
            "lis",
            "lu"
        ],
        correctIndex: 0
    },

    /* B1 */
    {
        level: "B1",
        type: "conversation",
        question: "Au travail : ¬´ Tu peux expliquer encore une fois ? ¬ª\nMeilleure r√©ponse :",
        options: [
            "Oui, bien s√ªr, je vais expliquer √©tape par √©tape.",
            "Non parler aujourd‚Äôhui.",
            "Je expliquer mais pas comprendre."
        ],
        correctIndex: 0
    },
    {
        level: "B1",
        type: "conversation",
        question: "Tu as rat√© le train.\nQuelle phrase est la plus naturelle ?",
        options: [
            "J‚Äôai rat√© mon train, quand est le prochain ?",
            "Train mauvais, moi f√¢ch√©.",
            "Pourquoi train partir ?"
        ],
        correctIndex: 0
    },
    {
        level: "B1",
        type: "grammar",
        question: "Choisis la phrase au pass√© correct :",
        options: [
            "Hier, je suis all√©(e) au cin√©ma.",
            "Hier, je vais au cin√©ma.",
            "Hier, j‚Äôallais au cin√©ma maintenant."
        ],
        correctIndex: 0
    },
    {
        level: "B1",
        type: "grammar",
        question: "Parler de l‚Äôexp√©rience professionnelle :",
        options: [
            "Je travaille dans l‚Äôinformatique depuis trois ans.",
            "Je travaille dans l‚Äôinformatique pendant trois ans (hier).",
            "Je travaille dans l‚Äôinformatique il y a trois ans."
        ],
        correctIndex: 0
    },

    /* B2 */
    {
        level: "B2",
        type: "conversation",
        question: "En r√©union : tu n‚Äôes pas d‚Äôaccord, mais poliment.\nQuelle phrase est la meilleure ?",
        options: [
            "Je comprends votre point de vue, mais je ne suis pas tout √† fait d‚Äôaccord.",
            "Tu as tort.",
            "Je n‚Äôaime pas ton id√©e."
        ],
        correctIndex: 0
    },
    {
        level: "B2",
        type: "conversation",
        question: "Entretien d‚Äôembauche : ¬´ Pourquoi devrions-nous vous engager ? ¬ª",
        options: [
            "Parce que j‚Äôapporte de l‚Äôexp√©rience, de la discipline et de bonnes capacit√©s d‚Äôanalyse.",
            "Parce que je veux de l‚Äôargent.",
            "Parce que je suis ici."
        ],
        correctIndex: 0
    },
    {
        level: "B2",
        type: "grammar",
        question: "Choisis la meilleure phrase (conditionnel) :",
        options: [
            "Si j‚Äôavais plus de temps, j‚Äôapprendrais une autre langue.",
            "Si j‚Äôai plus de temps, j‚Äôapprendrais une autre langue hier.",
            "Si j‚Äôaurai plus de temps, j‚Äôapprendra une autre langue."
        ],
        correctIndex: 0
    },
    {
        level: "B2",
        type: "grammar",
        question: "Lettre formelle : quel d√©but est le mieux ?",
        options: [
            "Madame, Monsieur,",
            "Salut toi,",
            "Yo chef,"
        ],
        correctIndex: 0
    }
];

/* DEUTSCH A1‚ÄìB2 ‚Äì Grammatik */
var deLanguageQuestions = [
    /* A1 */
    {
        level: "A1",
        type: "grammar",
        question: "W√§hle den richtigen Satz:",
        options: [
            "Ich bin Musti.",
            "Ich bist Musti.",
            "Ich sind Musti."
        ],
        correctIndex: 0
    },
    {
        level: "A1",
        type: "grammar",
        question: "Welche Antwort passt?\n‚ÄûWie geht es dir?‚Äú",
        options: [
            "Mir geht es gut, danke.",
            "Ich Fu√üball.",
            "Du Name Wasser."
        ],
        correctIndex: 0
    },
    {
        level: "A1",
        type: "grammar",
        question: "Richtiger Satz:",
        options: [
            "Das ist ein Buch.",
            "Das ein ist Buch.",
            "Ist das Buch ein."
        ],
        correctIndex: 0
    },

    /* A2 */
    {
        level: "A2",
        type: "grammar",
        question: "Welcher Satz ist richtig?",
        options: [
            "Ich stehe um 7 Uhr auf.",
            "Ich aufstehe um 7 Uhr.",
            "Ich stehe um auf 7 Uhr."
        ],
        correctIndex: 0
    },
    {
        level: "A2",
        type: "grammar",
        question: "Welche Antwort ist h√∂flich?\n‚ÄûK√∂nnen Sie mir bitte helfen?‚Äú",
        options: [
            "Ja, nat√ºrlich, ich helfe Ihnen gern.",
            "Nein.",
            "Sp√§ter vielleicht oder nie."
        ],
        correctIndex: 0
    },
    {
        level: "A2",
        type: "grammar",
        question: "Erg√§nze: ‚ÄûIch ______ in der Schweiz.‚Äú",
        options: [
            "wohne",
            "wohnt",
            "wohnen (ich)"
        ],
        correctIndex: 0
    },

    /* B1 */
    {
        level: "B1",
        type: "grammar",
        question: "W√§hle den besten Satz:",
        options: [
            "Ich lerne Deutsch, weil ich in der Schweiz lebe.",
            "Ich lerne Deutsch, weil ich lebe in der Schweiz.",
            "Ich lerne Deutsch, ich lebe weil in der Schweiz."
        ],
        correctIndex: 0
    },
    {
        level: "B1",
        type: "grammar",
        question: "Perfekt-Form w√§hlen:",
        options: [
            "Gestern habe ich lange gearbeitet.",
            "Gestern ich habe gearbeitet lange.",
            "Gestern habe gearbeitet ich lange."
        ],
        correctIndex: 0
    },
    {
        level: "B1",
        type: "conversation",
        question: "Kollege fragt: ‚ÄûKannst du mir das bitte erkl√§ren?‚Äú\nBeste Antwort:",
        options: [
            "Ja, klar. Ich erkl√§re es dir Schritt f√ºr Schritt.",
            "Nein, ich keine Lust.",
            "Sp√§ter, vielleicht nie."
        ],
        correctIndex: 0
    },

    /* B2 */
    {
        level: "B2",
        type: "grammar",
        question: "W√§hle die beste Version:",
        options: [
            "Obwohl ich m√ºde bin, mache ich die Aufgabe fertig.",
            "Ich bin m√ºde, obwohl mache ich die Aufgabe fertig.",
            "Obwohl m√ºde ich bin, ich mache fertig die Aufgabe."
        ],
        correctIndex: 0
    },
    {
        level: "B2",
        type: "grammar",
        question: "Formulierung im beruflichen Kontext:",
        options: [
            "K√∂nnten Sie mir bitte sagen, wann der Termin stattfindet?",
            "Sag mir, wann Termin ist.",
            "Hey, Termin wann?"
        ],
        correctIndex: 0
    },
    {
        level: "B2",
        type: "conversation",
        question: "Du bist nicht einverstanden, aber h√∂flich:",
        options: [
            "Ich verstehe Ihren Standpunkt, aber ich sehe es etwas anders.",
            "Du hast Unrecht.",
            "Deine Idee ist schlecht."
        ],
        correctIndex: 0
    }
];

/* FLAGGEN AFRIKA ‚Äì simple */
var flagQuestions = [
    {
        question: "Waa calanka Kenya?",
        options: [ "üá∞üá™", "üáßüá∑", "üá™üá∏" ],
        correctIndex: 0
    },
    {
        question: "Waa calanka Somalia?",
        options: [ "üá∏üá¥", "üá®üá≠", "üá∏üá™" ],
        correctIndex: 0
    },
    {
        question: "Waa calanka Ethiopia?",
        options: [ "üá™üáπ", "üá©üá™", "üá´üá∑" ],
        correctIndex: 0
    }
];

/* SCHWEIZ ‚Äì Kantone */
var chQuestions = [
    {
        question: "Kanton Wallis (VS) wuxuu caan ku yahay:",
        options: [
            "Buuraha iyo barafka (Matterhorn, ski)",
            "Xeebaha badda",
            "Cidlada lamadegaanka"
        ],
        correctIndex: 0
    },
    {
        question: "Graub√ºnden (GR) ‚Äì maxaa lagu yaqaan?",
        options: [
            "Alpen, ski, Davos & St. Moritz",
            "Jaziirado badeed",
            "Wabiga Nile"
        ],
        correctIndex: 0
    },
    {
        question: "Aargau (AG) wuxuu ku yaal:",
        options: [
            "Bartamaha/woqooyi, Rhine agtiisa",
            "Xeebta badweynta Hindiya",
            "Jasiirad ka tirsan Karibik"
        ],
        correctIndex: 0
    }
];

/* SOMALIA ‚Äì basic info */
var soInfoQuestions = [
    {
        question: "Waa kuwee caasimadda Soomaaliya?",
        options: [
            "Hargeysa",
            "Muqdisho",
            "Baydhabo"
        ],
        correctIndex: 1
    },
    {
        question: "Soomaaliya waxay madax-bannaani qaadatay:",
        options: [
            "1960",
            "1991",
            "2001"
        ],
        correctIndex: 0
    },
    {
        question: "Soomaaliya waxay leedahay xeeb dheer oo:",
        options: [
            "Badweynta Hindiya",
            "Badweynta Pacific",
            "Badweynta Atlantic"
        ],
        correctIndex: 0
    }
];

/* IT BASICS ‚Äì PC & Outlook */
var itBasicsQuestions = [
    {
        question: "Waa kee qayb ka mid ah kombiyuutarka (Hardware)?",
        options: [
            "CPU (Processor)",
            "E-mail",
            "Excel file"
        ],
        correctIndex: 0
    },
    {
        question: "Outlook waxaa loo isticmaalaa:",
        options: [
            "E-mail & Calendar",
            "Sawir-qaadis (Camera)",
            "Cunto kariyaha (K√ºche)"
        ],
        correctIndex: 0
    },
    {
        question: "Monitor-ka waxa uu muujinayaa:",
        options: [
            "Screen / shaashad",
            "Kaydinta gudaha (Harddisk)",
            "Koronto"
        ],
        correctIndex: 0
    }
];

/* CCNA ‚Äì Spanning Tree Protocol Basics */
var ccnaQuestions = [
    {
        question: "What is the main purpose of Spanning Tree Protocol (STP)?",
        options: [
            "To prevent Layer 2 loops in a switched network",
            "To route packets between different IP networks",
            "To assign IP addresses automatically"
        ],
        correctIndex: 0
    },
    {
        question: "Which STP concept decides which switch becomes the Root Bridge?",
        options: [
            "Bridge ID (Priority + MAC address)",
            "Port number only",
            "IP address of the switch"
        ],
        correctIndex: 0
    },
    {
        question: "In STP, which ports forward user traffic on the Root Bridge?",
        options: [
            "All ports are Designated and forward traffic",
            "Only one port forwards, the rest are blocked",
            "All ports are in blocking state"
        ],
        correctIndex: 0
    },
    {
        question: "Which STP port state forwards frames AND learns MAC addresses?",
        options: [
            "Forwarding",
            "Blocking",
            "Disabled"
        ],
        correctIndex: 0
    },
    {
        question: "Default STP bridge priority on Cisco switches (PVSTP+)?",
        options: [
            "32768",
            "4096",
            "100"
        ],
        correctIndex: 0
    },
    {
        question: "Which protocol type does STP use to exchange information between switches?",
        options: [
            "BPDU (Bridge Protocol Data Unit)",
            "ARP (Address Resolution Protocol)",
            "DNS (Domain Name System)"
        ],
        correctIndex: 0
    },
    {
        question: "A redundant link becomes active because the main link failed. STP will‚Ä¶",
        options: [
            "Move a previously blocked port to forwarding state",
            "Shut down all ports",
            "Change all ports to access mode"
        ],
        correctIndex: 0
    }
];

/* ========= GAME LOGIC ========= */

function chooseMode(mode){
    currentMode = mode;
    document.getElementById("feedbackBox").textContent = "";
    document.getElementById("optionsBox").innerHTML = "";

    document.getElementById("gameGrid").style.display = "none";
    document.getElementById("backBtn").style.display = "inline-block";

    var p = getActiveProfile();
    var inst = document.getElementById("instructions");
    var title = document.getElementById("gameTitle");

    title.textContent = getModeLabel(mode);

    if (!p) {
        inst.textContent = "Bitte zuerst ein Kind ausw√§hlen / Marka hore dooro ilmaha.";
    } else {
        var lvl = getProfileLevel(p, mode);
        var missionText = buildDailyMission(p);
        inst.textContent =
            "Kind: " + p.name +
            " ¬∑ Klasse: " + (p.grade === "special" ? "6/7" : p.grade) +
            " ¬∑ Level " + lvl + " in " + getModeLabel(mode) +
            " (5 richtig = Level up).\n" +
            missionText;
    }
    newQuestion();
}

function backToMenu() {
    currentMode = null;
    currentQuestion = null;
    document.getElementById("gameGrid").style.display = "grid";
    document.getElementById("backBtn").style.display = "none";
    document.getElementById("questionBox").textContent = "Frage / Su‚Äôaal ayaa halkan iman doonta.";
    document.getElementById("optionsBox").innerHTML = "";
    document.getElementById("feedbackBox").textContent = "";
    document.getElementById("gameTitle").textContent = "Spiel w√§hlen / Doorow Spiel";
    document.getElementById("instructions").textContent =
        "Dooro ilmuhu kor, kadibna dooro modul (Mathe, Sprachen, Somalia, Schweiz, CCNA...).";
}

function newQuestion(){
    var qBox = document.getElementById("questionBox");
    var optionsBox = document.getElementById("optionsBox");
    optionsBox.innerHTML = "";
    document.getElementById("feedbackBox").textContent = "";
    currentQuestion = null;

    if (!currentMode) {
        qBox.textContent = "Dooro Spiel kor / W√§hle ein Spiel oben.";
        return;
    }

    var qData = null;

    if (currentMode === "add") {
        var a = randomInt(1,20);
        var b = randomInt(1,20);
        var ans = a + b;
        var wrong1 = ans + randomInt(1,3);
        var wrong2 = ans - randomInt(1,3);
        if (wrong2 < 0) wrong2 = ans + 4;
        var options = shuffle([ans, wrong1, wrong2]);
        qData = { question: a + " + " + b + " = ?", options: options.map(String), correctIndex: options.indexOf(ans) };
    } else if (currentMode === "sub") {
        var a2 = randomInt(5,30);
        var b2 = randomInt(1,a2);
        var ans2 = a2 - b2;
        var w1 = ans2 + randomInt(1,3);
        var w2 = ans2 - randomInt(1,3);
        if (w2 < 0) w2 = ans2 + 4;
        var opts2 = shuffle([ans2, w1, w2]);
        qData = { question: a2 + " ‚àí " + b2 + " = ?", options: opts2.map(String), correctIndex: opts2.indexOf(ans2) };
    } else if (currentMode === "mul") {
        var m1 = randomInt(1,10);
        var m2 = randomInt(1,10);
        var mans = m1 * m2;
        var mw1 = mans + randomInt(1,5);
        var mw2 = mans - randomInt(1,5);
        if (mw2 < 0) mw2 = mans + 6;
        var mopts = shuffle([mans, mw1, mw2]);
        qData = { question: m1 + " √ó " + m2 + " = ?", options: mopts.map(String), correctIndex: mopts.indexOf(mans) };
    } else if (currentMode === "frac") {
        var fracQs = [
            {q: "1/2 von 8 = ? (Af-Soomaali: nus ka mid ah 8?)", a: 4},
            {q: "1/3 von 9 = ? (Af-Soomaali: 1/3 ka mid ah 9?)", a: 3},
            {q: "1/4 von 20 = ? (Af-Soomaali: rubuc ka mid ah 20?)", a: 5}
        ];
        var fq = fracQs[randomInt(0, fracQs.length-1)];
        var fAns = fq.a;
        var fw1 = fAns + randomInt(1,3);
        var fw2 = fAns - randomInt(1,2);
        if (fw2 < 0) fw2 = fAns + 2;
        var fopts = shuffle([fAns, fw1, fw2]);
        qData = { question: fq.q, options: fopts.map(String), correctIndex: fopts.indexOf(fAns) };
    } else if (currentMode === "de") {
        var a3 = randomInt(1,20);
        var b3 = randomInt(1,20);
        var ans3 = a3 + b3;
        var dw1 = ans3 + randomInt(1,4);
        var dw2 = ans3 - randomInt(1,4);
        if (dw2 < 0) dw2 = ans3 + 3;
        var dopts = shuffle([ans3, dw1, dw2]);
        qData = { question: "Wie viel ist " + a3 + " plus " + b3 + " ?", options: dopts.map(String), correctIndex: dopts.indexOf(ans3) };
    } else if (currentMode === "en") {
        qData = pickFromArray(enQuestions);
    } else if (currentMode === "fr") {
        qData = pickFromArray(frQuestions);
    } else if (currentMode === "delang") {
        qData = pickFromArray(deLanguageQuestions);
    } else if (currentMode === "itbasics") {
        qData = pickFromArray(itBasicsQuestions);
    } else if (currentMode === "flags") {
        qData = pickFromArray(flagQuestions);
    } else if (currentMode === "chgeo") {
        qData = pickFromArray(chQuestions);
    } else if (currentMode === "soinfo") {
        qData = pickFromArray(soInfoQuestions);
    } else if (currentMode === "ccna") {
        qData = pickFromArray(ccnaQuestions);
    }

    if (!qData) {
        qBox.textContent = "Su‚Äôaal lama helin.";
        return;
    }

    currentQuestion = qData;
    qBox.textContent = qData.question;

    qData.options.forEach(function(optText, idx){
        var btn = document.createElement("button");
        btn.className = "option-btn";
        btn.textContent = (idx+1) + ") " + optText;
        btn.onclick = function(){ handleChoice(idx); };
        optionsBox.appendChild(btn);
    });
}

function pickFromArray(arr) {
    if (!arr || !arr.length) return null;
    var i = randomInt(0, arr.length-1);
    return {
        question: arr[i].question,
        options: arr[i].options.slice(),
        correctIndex: arr[i].correctIndex
    };
}

function handleChoice(index){
    if (!currentQuestion) return;
    var fb = document.getElementById("feedbackBox");
    var isCorrect = (index === currentQuestion.correctIndex);

    var p = getActiveProfile();
    if (p && currentMode) {
        ensureModules(p);

        var mod = p.modules[currentMode];
        if (!mod) {
            mod = {correct:0,total:0};
            p.modules[currentMode] = mod;
        }
        mod.total++;
        if (isCorrect) mod.correct++;

        updateDailyOnAnswer();
        if (!p.score) p.score = 0;
        if (isCorrect) {
            p.score++;
            score = p.score;
        }
        saveProfiles();
        renderHallOfFame();
        renderProfileButtons();
        updateScoreUI();
    }

    if (isCorrect) {
        fb.textContent = "Richtig! / Waa sax üëè";
        fb.style.color = "green";
        setTimeout(function(){ newQuestion(); }, 900);
    } else {
        fb.textContent = "Falsch. Versuch es noch einmal. / Khalad, mar kale isku day.";
        fb.style.color = "red";
    }
}

/* ========= INIT ========= */

applyDarkFromStorage();
loadProfiles();
updateScoreUI();

</script>

</body>
</html>
