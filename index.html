<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mustis Lernwelt ‚Äì Mathe, Sprachen & Weltwissen</title>

<style>
    :root {
        --bg: #84c0f0;
        --header-bg: linear-gradient(90deg,#014a94,#018ba8);
        --text: #000000;
        --card-bg: #ffffff;
        --card-shadow: rgba(0,0,0,0.3);
        --accent: #0056a6;
        --score-bg: #1b75d0;
        --side-bg: #fffbcc;
        --button-ok: #28a745;
        --button-ok-hover: #218838;
        --menu-bg: #ffffff;
        --menu-hover: #e3f2ff;
        --input-border: #ccc;
    }

    body.dark-mode {
        --bg: #021626;
        --header-bg: linear-gradient(90deg,#000814,#003566);
        --text: #f5f5f5;
        --card-bg: #0f2233;
        --card-shadow: rgba(0,0,0,0.8);
        --accent: #2296ff;
        --score-bg: #004080;
        --side-bg: #2d2a0f;
        --button-ok: #1c8c3a;
        --button-ok-hover: #0f6b2a;
        --menu-bg: #071521;
        --menu-hover: #123047;
        --input-border: #555;
    }

    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        text-align: center;
    }

    header {
        background: var(--header-bg);
        padding: 10px 12px 8px;
        color: white;
        font-size: 20px;
        font-weight: bold;
        display: flex;
        align-items: stretch;
        justify-content: space-between;
        box-sizing: border-box;
        box-shadow: 0 3px 10px rgba(0,0,0,0.4);
    }

    .header-center {
        flex: 1;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: 0 8px;
    }

    .header-title {
        font-size: 20px;
        letter-spacing: 0.5px;
    }

    .header-sub {
        display: block;
        font-size: 12px;
        margin-top: 3px;
        font-weight: normal;
        opacity: 0.95;
    }

    .flag-hero {
        width: 90px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
    }

    .flag-hero-inner {
        width: 100%;
        border-radius: 10px;
        padding: 4px 4px 6px;
        box-shadow: 0 0 6px rgba(0,0,0,0.5);
        background-size: cover;
        background-position: center;
        position: relative;
        overflow: hidden;
    }

    .flag-hero-so {
        background-image: linear-gradient(to bottom,#0099ff,#00c8ff 40%,#ffe9b3);
    }

    .flag-hero-ch {
        background-image: linear-gradient(to bottom,#e0f5ff,#cde7ff 45%,#ffffff);
    }

    .flag-hero img {
        height: 26px;
        border-radius: 4px;
        box-shadow: 0 0 4px rgba(0,0,0,0.4);
        border: 1px solid rgba(255,255,255,0.8);
        background: rgba(255,255,255,0.7);
    }

    .flag-scene {
        margin-top: 4px;
        font-size: 13px;
        font-weight: bold;
        text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }

    .flag-scene span {
        display: block;
        font-size: 10px;
        font-weight: normal;
    }

    .top-bar {
        margin: 10px auto 0;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: center;
        align-items: center;
        font-size: 13px;
    }
    .top-bar select,
    .top-bar button {
        padding: 6px 10px;
        border-radius: 10px;
        border: 1px solid var(--input-border);
        background: var(--card-bg);
        color: var(--text);
        font-size: 13px;
    }
    .top-bar button {
        cursor: pointer;
        border: none;
        background: var(--accent);
        color: #fff;
        font-weight: bold;
    }
    .top-bar button:hover {
        opacity: 0.9;
    }
    .top-label {
        font-weight: bold;
    }
    .score {
        font-weight: bold;
        color: #fff;
        background: var(--score-bg);
        padding: 4px 10px;
        border-radius: 10px;
        font-size: 13px;
    }
    .dark-toggle label {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 13px;
        cursor: pointer;
    }

    .profile-buttons-bar {
        max-width: 900px;
        margin: 6px auto 0;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: center;
    }
    .profile-buttons-bar button {
        border-radius: 999px;
        border: none;
        padding: 4px 10px;
        font-size: 12px;
        cursor: pointer;
        background: rgba(0,0,0,0.08);
        color: var(--text);
    }
    .profile-buttons-bar button.active {
        background: var(--accent);
        color: #fff;
    }
    .profile-buttons-bar button:hover {
        opacity: 0.9;
    }

    .menu-bar {
        margin: 15px auto 5px;
        max-width: 450px;
    }
    .hamburger-btn {
        width: 100%;
        padding: 10px 14px;
        border-radius: 12px;
        border: none;
        background: var(--accent);
        color: white;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        box-shadow: 0 3px 6px var(--card-shadow);
    }
    .hamburger-icon {
        font-size: 20px;
    }
    .menu-list {
        margin-top: 6px;
        display: none;
        background: var(--menu-bg);
        border-radius: 12px;
        box-shadow: 0 3px 8px var(--card-shadow);
        overflow: hidden;
    }
    .menu-item {
        width: 100%;
        padding: 10px 14px;
        border: none;
        background: transparent;
        cursor: pointer;
        text-align: left;
        font-size: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: var(--text);
    }
    .menu-item span {
        font-size: 18px;
        margin-right: 8px;
    }
    .menu-item small {
        font-size: 12px;
        opacity: 0.8;
    }
    .menu-item:hover {
        background: var(--menu-hover);
    }

    .game-area {
        max-width: 520px;
        margin: 15px auto 20px;
        background: var(--card-bg);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 10px var(--card-shadow);
        text-align: center;
    }
    .game-area h2 {
        margin-top: 0;
    }
    .question {
        font-size: 20px;
        margin: 10px 0;
        white-space: pre-line;
    }
    .hint {
        font-size: 13px;
        margin-bottom: 8px;
    }
    body.dark-mode .hint {
        color: #cccccc;
    }
    body:not(.dark-mode) .hint {
        color: #555555;
    }

    .answers {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
    }
    .answers button {
        padding: 8px 14px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        min-width: 70px;
        font-weight: bold;
        color: #fff;
    }

    /* Mathe / Deutsch */
    .answers-math button {
        background: #28a745;
    }
    .answers-math button:hover {
        background: #1f7f37;
    }

    /* Lesen */
    .answers-read button {
        background: #ff9800;
    }
    .answers-read button:hover {
        background: #e68900;
    }

    /* Sprachen (Englisch / Franz√∂sisch) ‚Äì text options */
    .answers-lang button {
        background: #007bff;
        border-radius: 999px;
        padding-inline: 18px;
    }
    .answers-lang button:hover {
        background: #0062cc;
    }

    /* Informatik */
    .answers-it button {
        background: #9c27b0;
    }
    .answers-it button:hover {
        background: #7b1fa2;
    }

    /* Geografie (Schweiz / Somalia) ‚Äì card style */
    .answers-geo button {
        background: #009688;
        border-radius: 12px;
        padding: 8px 16px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.4);
        white-space: nowrap;
    }
    .answers-geo button:hover {
        background: #00796b;
        transform: translateY(-1px);
    }

    /* Flaggen ‚Äì special */
    .answers-flags {
        gap: 16px;
    }
    .answers-flags button {
        background: transparent;
        border: 2px solid transparent;
        border-radius: 12px;
        padding: 6px 8px;
        color: var(--text);
        min-width: 80px;
    }
    .answers-flags button img {
        display: block;
        height: 40px;
        margin: 0 auto 4px;
        border-radius: 6px;
        box-shadow: 0 0 4px rgba(0,0,0,0.4);
    }
    .answers-flags button span {
        font-size: 12px;
        display: block;
    }
    .answers-flags button:hover {
        border-color: var(--accent);
        background: rgba(255,255,255,0.12);
    }

    .feedback {
        margin-top: 10px;
        font-weight: bold;
        white-space: pre-line;
    }

    .side-info {
        max-width: 900px;
        margin: 0 auto 30px;
        background: var(--side-bg);
        border-radius: 12px;
        padding: 10px 15px 15px;
        font-size: 14px;
        text-align: left;
        color: var(--text);
    }
    .side-info h3 {
        margin-top: 5px;
    }
    .side-info ul {
        padding-left: 20px;
        margin: 5px 0 10px;
    }
    .hall-item {
        font-size: 13px;
        margin-bottom: 10px;
    }

    .hall-bars {
        margin-top: 4px;
        margin-bottom: 4px;
    }
    .bar-row {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 3px;
    }
    .bar-row-label {
        width: 80px;
        font-size: 12px;
    }
    .bar-row-bar {
        flex: 1;
        background: rgba(0,0,0,0.1);
        border-radius: 999px;
        overflow: hidden;
        height: 8px;
    }
    .bar-row-bar-fill {
        height: 8px;
        border-radius: 999px;
    }
    .bar-row-bar-fill-mathe {
        background: #28a745;
    }
    .bar-row-bar-fill-lesen {
        background: #ff9800;
    }
    .bar-row-bar-fill-sprache {
        background: #007bff;
    }
    .bar-row-bar-fill-wissen {
        background: #009688;
    }
    .bar-row-pct {
        width: 38px;
        font-size: 11px;
        text-align: right;
    }

    .hall-feedback {
        font-size: 12px;
        font-style: italic;
        margin-top: 2px;
    }

    .hall-testbutton {
        margin-top: 4px;
    }
    .hall-testbutton button {
        padding: 3px 10px;
        border-radius: 999px;
        border: none;
        font-size: 11px;
        cursor: pointer;
        background: var(--accent);
        color: #fff;
    }
    .hall-testbutton button:hover {
        opacity: 0.9;
    }
</style>
</head>
<body>

<header>
  <!-- Somalia side ‚Äì Beach & Play -->
  <div class="flag-hero">
    <div class="flag-hero-inner flag-hero-so">
      <img src="https://flagcdn.com/w40/so.png" alt="Somalia">
      <div class="flag-scene">
        üèñÔ∏èüå¥‚öΩ
        <span>Xeeb dheer & ciyaar</span>
      </div>
    </div>
  </div>

  <!-- Center title -->
  <div class="header-center">
    <div class="header-title">
      Mustis Lernwelt ‚Äì Mathe, Sprachen & Weltwissen
    </div>
    <small class="header-sub">
      ‚ÄûXisaab, luqado & juquraafi‚Äú ‚Äì spielerisch lernen f√ºr 1.‚Äì6. Klasse
    </small>
  </div>

  <!-- Switzerland side ‚Äì Alps & Cable Car -->
  <div class="flag-hero">
    <div class="flag-hero-inner flag-hero-ch">
      <img src="https://flagcdn.com/w40/ch.png" alt="Schweiz">
      <div class="flag-scene">
        üèîÔ∏èüö°‚õ∑Ô∏è
        <span>Berge, Schnee & Lifte</span>
      </div>
    </div>
  </div>
</header>

<div class="top-bar">
    <span class="top-label">Kind:</span>
    <select id="profileSelect" onchange="selectProfile()">
        <option value="">‚Äì Kind w√§hlen ‚Äì</option>
    </select>
    <button type="button" onclick="addProfile()">Neues Kind</button>
    <button type="button" onclick="resetActiveProfile()">Reset Profil</button>

    <span class="top-label">Klasse:</span>
    <select id="gradeSelect" onchange="updateGrade()">
        <option value="1">1. Klasse</option>
        <option value="2">2. Klasse</option>
        <option value="3">3. Klasse</option>
        <option value="4">4. Klasse</option>
        <option value="5">5. Klasse</option>
        <option value="6">6. Klasse</option>
        <option value="special">Spezial 6/7</option>
    </select>

    <span class="score" id="scoreBox">Punkte: 0</span>

    <div class="dark-toggle">
        <label>
            <input type="checkbox" id="darkToggle" onchange="toggleDarkMode()">
            üåô Dark Mode
        </label>
    </div>
</div>

<div id="profileButtonsBar" class="profile-buttons-bar"></div>

<div class="menu-bar">
    <button class="hamburger-btn" onclick="toggleMenu()">
        <span class="hamburger-icon">‚ò∞</span>
        Spiele w√§hlen (Mathe / Sprachen / Wissen)
    </button>
    <div class="menu-list" id="menuList">
        <button class="menu-item" onclick="chooseMode('add')">
            <span>‚ûï</span> Addition <small>Einfache Plus-Aufgaben</small>
        </button>
        <button class="menu-item" onclick="chooseMode('sub')">
            <span>‚ûñ</span> Subtraktion <small>Minus & Unterschiede</small>
        </button>
        <button class="menu-item" onclick="chooseMode('mul')">
            <span>‚úñÔ∏è</span> Multiplikation <small>Mal-Rechnen</small>
        </button>
        <button class="menu-item" onclick="chooseMode('frac')">
            <span>üß©</span> Br√ºche <small>Teile vom Ganzen</small>
        </button>
        <button class="menu-item" onclick="chooseMode('de')">
            <span>üá©üá™</span> Deutschaufgaben <small>‚ÄûWie viele‚Ä¶‚Äú S√§tze</small>
        </button>
        <button class="menu-item" onclick="chooseMode('read')">
            <span>üìñ</span> Lesen / Leseverstehen <small>Text + Frage</small>
        </button>
        <button class="menu-item" onclick="chooseMode('en')">
            <span>üá¨üáß</span> Englisch <small>W√∂rter & Farben (Optionen)</small>
        </button>
        <button class="menu-item" onclick="chooseMode('fr')">
            <span>üá´üá∑</span> Franz√∂sisch <small>W√∂rter & Farben (Optionen)</small>
        </button>
        <button class="menu-item" onclick="chooseMode('itbasics')">
            <span>üíª</span> Informatik Basics <small>PC, Maus, Tastatur, Outlook</small>
        </button>
        <button class="menu-item" onclick="chooseMode('flags')">
            <span>üåç</span> Flaggen Afrika <small>Calan + Waddan</small>
        </button>
        <button class="menu-item" onclick="chooseMode('chgeo')">
            <span>üèîÔ∏è</span> Schweiz & Kantone <small>Berge, St√§dte & Sport</small>
        </button>
        <button class="menu-item" onclick="chooseMode('soinfo')">
            <span>üá∏üá¥</span> Somalia & Geografie <small>Taariikh, Gobollo, Xeebaha</small>
        </button>
    </div>
</div>

<div class="game-area" id="gameArea" style="display:none;">
    <h2 id="gameTitle">Spiel</h2>
    <p class="hint" id="instructions">
      W√§hle oben ein Spiel und ein Kind aus.
    </p>
    <div class="question" id="questionBox">Frage</div>
    <div id="answersContainer" class="answers"></div>
    <div class="feedback" id="feedbackBox"></div>
</div>

<div class="side-info">
    <h3>Profile, Klassen & Fortschritt</h3>
    <ul>
        <li>Bis zu 10 Kinder (Profile) ‚Äì jedes mit:
            <ul>
                <li>Name & Klasse (1‚Äì6 oder Spezial 6/7)</li>
                <li>Punkte (Score)</li>
                <li>Level pro Modul (5 Fragen, ab 4 Richtigen ‚Üí n√§chstes Level)</li>
                <li>Modul-Fortschritt:
                    <b>Mathe</b>, <b>Lesen</b>, <b>Sprachen</b>, <b>Wissen (IT + L√§nder)</b>.
                </li>
            </ul>
        </li>
        <li>Oben siehst du Namens-Buttons, um schnell ein Kind zu w√§hlen.</li>
        <li>‚ÄûReset Profil‚Äú setzt Punkte und Level vom aktiven Kind zur√ºck.</li>
    </ul>

    <h3>Hall of Fame ‚Äì √úbersicht pro Kind</h3>
    <div id="hallOfFame"></div>
</div>

<script>
/* ---------- GLOBAL STATE ---------- */
var currentMode = null;
var currentQuestion = null;
var score = 0;
var currentGrade = "1";
var profiles = [];
var activeProfileId = null;
var STORAGE_KEY = "musti_playground_profiles_v6";

/* Level-run: 5 Fragen ‚Üí 4+ richtig = Level up */
var currentRun = { mode: null, count: 0, correct: 0 };

/* ---------- QUESTION POOLS ---------- */

/* Englisch ‚Äì Optionen */
var enQuestions = [
    /* A1 ‚Äì Greetings & Basics */
    {
        level: "A1",
        type: "conversation",
        question: "You meet someone. They say: ‚ÄúHello, how are you?‚Äù\nWhich answer is best?",
        options: [
            "I am fine, thank you.",
            "I cooking.",
            "You are name."
        ],
        correctIndex: 0
    },
    {
        level: "A1",
        type: "conversation",
        question: "You are in a shop and want bread.\nWhat do you say?",
        options: [
            "One bread, please.",
            "I am bread.",
            "Give bread now."
        ],
        correctIndex: 0
    },
    {
        level: "A1",
        type: "grammar",
        question: "Choose the correct sentence:",
        options: [
            "He is my friend.",
            "He are my friend.",
            "He am my friend."
        ],
        correctIndex: 0
    },
    {
        level: "A1",
        type: "grammar",
        question: "Which sentence is correct?",
        options: [
            "I have a dog.",
            "I has a dog.",
            "I having a dog."
        ],
        correctIndex: 0
    },

    /* A2 ‚Äì Everyday situations & Present Continuous */
    {
        level: "A2",
        type: "conversation",
        question: "You call a friend: ‚ÄúCan we meet this afternoon?‚Äù\nBest answer:",
        options: [
            "Yes, I am free after 4 o‚Äôclock.",
            "Yes, I free 4.",
            "I tomorrow free."
        ],
        correctIndex: 0
    },
    {
        level: "A2",
        type: "conversation",
        question: "At the doctor: ‚ÄúWhat‚Äôs the problem?‚Äù\nWhat do you say?",
        options: [
            "I have a headache and feel tired.",
            "You have problem.",
            "My head is very interesting."
        ],
        correctIndex: 0
    },
    {
        level: "A2",
        type: "grammar",
        question: "Correct present continuous:",
        options: [
            "She is reading a book.",
            "She reading a book.",
            "She are reading a book."
        ],
        correctIndex: 0
    },
    {
        level: "A2",
        type: "grammar",
        question: "Fill the gap: ‚ÄúI am ______ for a new job.‚Äù",
        options: [
            "looking",
            "look",
            "looked"
        ],
        correctIndex: 0
    },

    /* B1 ‚Äì Work & Problem Situations */
    {
        level: "B1",
        type: "conversation",
        question: "At work: ‚ÄúCan you explain this again?‚Äù\nBest answer:",
        options: [
            "Sure, let me explain it step by step.",
            "No talk today.",
            "I explain but no understand."
        ],
        correctIndex: 0
    },
    {
        level: "B1",
        type: "conversation",
        question: "You missed the train.\nWhat is the most natural sentence?",
        options: [
            "I missed my train, when is the next one?",
            "Train bad, me angry.",
            "Why train go?"
        ],
        correctIndex: 0
    },
    {
        level: "B1",
        type: "grammar",
        question: "Choose the correct past tense sentence:",
        options: [
            "Yesterday I went to the cinema.",
            "Yesterday I go to the cinema.",
            "Yesterday I was go to the cinema."
        ],
        correctIndex: 0
    },
    {
        level: "B1",
        type: "grammar",
        question: "Correct sentence for talking about experience:",
        options: [
            "I have worked in IT for three years.",
            "I am working in IT since three years.",
            "I was work in IT for three years."
        ],
        correctIndex: 0
    },

    /* B2 ‚Äì Professional & Polite Language */
    {
        level: "B2",
        type: "conversation",
        question: "Meeting: ‚ÄúCan you summarize the main point?‚Äù\nBest answer:",
        options: [
            "Yes, the main point is that we need to improve our workflow efficiency.",
            "Yes, main point good.",
            "Summary no."
        ],
        correctIndex: 0
    },
    {
        level: "B2",
        type: "conversation",
        question: "You disagree politely in a meeting.",
        options: [
            "I understand your point, but I see it differently.",
            "You are wrong.",
            "I don‚Äôt like your idea."
        ],
        correctIndex: 0
    },
    {
        level: "B2",
        type: "grammar",
        question: "Choose the best sentence:",
        options: [
            "If I had more time, I would learn another language.",
            "If I will have more time, I learn another language.",
            "If I have more time, I would learn another language (yesterday)."
        ],
        correctIndex: 0
    },
    {
        level: "B2",
        type: "grammar",
        question: "Formal e-mail:\nWhich opening is best?",
        options: [
            "Dear Sir or Madam,",
            "Hey you,",
            "Yo boss,"
        ],
        correctIndex: 0
    }
];

/* Franz√∂sisch ‚Äì Optionen */
var frQuestions = [
    /* A1 ‚Äì Saluer & se pr√©senter */
    {
        level: "A1",
        type: "conversation",
        question: "Quelle est la meilleure r√©ponse ?\n¬´ Bonjour, √ßa va ? ¬ª",
        options: [
            "√áa va bien, merci.",
            "Je pain.",
            "Tu nom eau."
        ],
        correctIndex: 0
    },
    {
        level: "A1",
        type: "conversation",
        question: "Au magasin : tu veux du pain.\nQue dis-tu ?",
        options: [
            "Un pain, s‚Äôil vous pla√Æt.",
            "Je suis pain.",
            "Donne pain maintenant."
        ],
        correctIndex: 0
    },
    {
        level: "A1",
        type: "grammar",
        question: "Choisis la phrase correcte :",
        options: [
            "Il est mon ami.",
            "Il sont mon ami.",
            "Il es mon ami."
        ],
        correctIndex: 0
    },
    {
        level: "A1",
        type: "grammar",
        question: "Quelle phrase est correcte ?",
        options: [
            "J‚Äôai un chien.",
            "Je ai un chien.",
            "Je avoir un chien."
        ],
        correctIndex: 0
    },

    /* A2 ‚Äì Vie quotidienne & pr√©sent */
    {
        level: "A2",
        type: "conversation",
        question: "Tu appelles un ami : ¬´ On peut se voir cet apr√®s-midi ? ¬ª\nMeilleure r√©ponse :",
        options: [
            "Oui, je suis libre apr√®s 16 heures.",
            "Oui, moi libre 16.",
            "Je demain libre."
        ],
        correctIndex: 0
    },
    {
        level: "A2",
        type: "conversation",
        question: "Chez le m√©decin : ¬´ Quel est le probl√®me ? ¬ª\nQue dis-tu ?",
        options: [
            "J‚Äôai mal √† la t√™te et je suis fatigu√©(e).",
            "Tu as probl√®me.",
            "Ma t√™te est tr√®s int√©ressante."
        ],
        correctIndex: 0
    },
    {
        level: "A2",
        type: "grammar",
        question: "Choisis le verbe au pr√©sent correct :\n¬´ Nous ______ au cin√©ma. ¬ª",
        options: [
            "allons",
            "allez",
            "vas"
        ],
        correctIndex: 0
    },
    {
        level: "A2",
        type: "grammar",
        question: "Compl√®te : ¬´ Je suis en train de ______ un livre. ¬ª",
        options: [
            "lire",
            "lis",
            "lu"
        ],
        correctIndex: 0
    },

    /* B1 ‚Äì Travail & situations plus longues */
    {
        level: "B1",
        type: "conversation",
        question: "Au travail : ¬´ Tu peux expliquer encore une fois ? ¬ª\nMeilleure r√©ponse :",
        options: [
            "Oui, bien s√ªr, je vais expliquer √©tape par √©tape.",
            "Non parler aujourd‚Äôhui.",
            "Je expliquer mais pas comprendre."
        ],
        correctIndex: 0
    },
    {
        level: "B1",
        type: "conversation",
        question: "Tu as rat√© le train.\nQuelle phrase est la plus naturelle ?",
        options: [
            "J‚Äôai rat√© mon train, quand est le prochain ?",
            "Train mauvais, moi f√¢ch√©.",
            "Pourquoi train partir ?"
        ],
        correctIndex: 0
    },
    {
        level: "B1",
        type: "grammar",
        question: "Choisis la phrase au pass√© correct :",
        options: [
            "Hier, je suis all√©(e) au cin√©ma.",
            "Hier, je vais au cin√©ma.",
            "Hier, j‚Äôallais au cin√©ma maintenant."
        ],
        correctIndex: 0
    },
    {
        level: "B1",
        type: "grammar",
        question: "Parler de l‚Äôexp√©rience professionnelle :",
        options: [
            "Je travaille dans l‚Äôinformatique depuis trois ans.",
            "Je travaille dans l‚Äôinformatique pendant trois ans (hier).",
            "Je travaille dans l‚Äôinformatique il y a trois ans."
        ],
        correctIndex: 0
    },

    /* B2 ‚Äì Langue formelle & nuanc√©e */
    {
        level: "B2",
        type: "conversation",
        question: "En r√©union : tu n‚Äôes pas d‚Äôaccord, mais poliment.\nQuelle phrase est la meilleure ?",
        options: [
            "Je comprends votre point de vue, mais je ne suis pas tout √† fait d‚Äôaccord.",
            "Tu as tort.",
            "Je n‚Äôaime pas ton id√©e."
        ],
        correctIndex: 0
    },
    {
        level: "B2",
        type: "conversation",
        question: "Entretien d‚Äôembauche : ¬´ Pourquoi devrions-nous vous engager ? ¬ª",
        options: [
            "Parce que j‚Äôapporte de l‚Äôexp√©rience, de la discipline et de bonnes capacit√©s d‚Äôanalyse.",
            "Parce que je veux de l‚Äôargent.",
            "Parce que je suis ici."
        ],
        correctIndex: 0
    },
    {
        level: "B2",
        type: "grammar",
        question: "Choisis la meilleure phrase (conditionnel) :",
        options: [
            "Si j‚Äôavais plus de temps, j‚Äôapprendrais une autre langue.",
            "Si j‚Äôai plus de temps, j‚Äôapprendrais une autre langue hier.",
            "Si j‚Äôaurai plus de temps, j‚Äôapprendra une autre langue."
        ],
        correctIndex: 0
    },
    {
        level: "B2",
        type: "grammar",
        question: "Lettre formelle : quel d√©but est le mieux ?",
        options: [
            "Madame, Monsieur,",
            "Salut toi,",
            "Yo chef,"
        ],
        correctIndex: 0
    }
];

/* Informatik Basics ‚Äì Optionen */
var itBasicsQuestions = [
    {
        question: "Welches Ger√§t ist ein Computer?",
        options: ["Laptop", "Maus", "Tastatur"],
        correctIndex: 0
    },
    {
        question: "Das kleine Ger√§t in der Hand zum Klicken. Was ist das?",
        options: ["Bildschirm", "Maus", "Drucker"],
        correctIndex: 1
    },
    {
        question: "Damit tippst du Buchstaben und Zahlen. Was ist das?",
        options: ["Lautsprecher", "Tastatur", "Kabel"],
        correctIndex: 1
    },
    {
        question: "Wof√ºr benutzt man Outlook meistens?",
        options: ["E-Mails", "Spiele", "Musik"],
        correctIndex: 0
    },
    {
        question: "Was ist ein gutes Passwort?",
        options: ["nur Name", "lang & gemischt", "nur 1234"],
        correctIndex: 1
    }
];

/* Flaggen Afrika ‚Äì jawaabtu waa calan (code) */
var flagQuestions = [
    {
        country: "Soomaaliya",
        correct: "so",
        others: ["ke","et"],
        hint: "Eselsbr√ºcke: Soomaaliya üá∏üá¥ = buluug (bad & cirka) + xiddig cad oo dhexe kaga taal."
    },
    {
        country: "Kenia",
        correct: "ke",
        others: ["so","ng"],
        hint: "Eselsbr√ºcke: Kenia üá∞üá™ ‚Äì gaashaan madow oo dhexe yaal, sida geesi duurka ilaalinaya."
    },
    {
        country: "√Ñthiopien",
        correct: "et",
        others: ["so","za"],
        hint: "Eselsbr√ºcke: √Ñthiopien üá™üáπ ‚Äì cagaar-jaalle-cas + xiddig dhexda, calan taariikhi ah."
    },
    {
        country: "Nigeria",
        correct: "ng",
        others: ["gh","ke"],
        hint: "Eselsbr√ºcke: Nigeria üá≥üá¨ ‚Äì cagaar-cad-cagaar, sida labo geed cagaaran iyo wabiga dhexda maraya."
    },
    {
        country: "S√ºdafrika",
        correct: "za",
        others: ["ng","ke"],
        hint: "Eselsbr√ºcke: S√ºdafrika üáøüá¶ ‚Äì midabyo badan + xaraf Y, waddooyin badan oo isku yimaada."
    }
];

var flagMap = {
    so: { url: "https://flagcdn.com/w80/so.png", label: "Soomaaliya" },
    ke: { url: "https://flagcdn.com/w80/ke.png", label: "Kenia" },
    et: { url: "https://flagcdn.com/w80/et.png", label: "√Ñthiopien" },
    ng: { url: "https://flagcdn.com/w80/ng.png", label: "Nigeria" },
    za: { url: "https://flagcdn.com/w80/za.png", label: "S√ºdafrika" },
    gh: { url: "https://flagcdn.com/w80/gh.png", label: "Ghana" }
};

/* Lesen / Leseverstehen */
var readQuestions = [
    {
        min: 1, max: 2,
        text: "üìñ Lesen (1.‚Äì2. Klasse)\n\nTom hat einen roten Ball. Er spielt im Garten.\n\nFrage: Wo spielt Tom?\n1) In der Schule   2) Im Garten   3) Im Auto",
        ans: 2
    },
    {
        min: 1, max: 2,
        text: "üìñ Lesen (1.‚Äì2. Klasse)\n\nLina hat 3 B√ºcher. Sie liest gern im Bett.\n\nFrage: Wo liest Lina?\n1) Im Bett   2) Auf dem Spielplatz   3) Im Bus",
        ans: 1
    },
    {
        min: 3, max: 4,
        text: "üìñ Lesen (3.‚Äì4. Klasse)\n\nMax f√§hrt mit dem Bus zur Schule. Der Bus braucht 15 Minuten.\n\nFrage: Womit f√§hrt Max zur Schule?\n1) Mit dem Auto   2) Mit dem Bus   3) Zu Fu√ü",
        ans: 2
    },
    {
        min: 3, max: 4,
        text: "üìñ Lesen (3.‚Äì4. Klasse)\n\nIm Sommer geht die Klasse 3a ins Schwimmbad. Alle bringen Handt√ºcher und Badehosen mit.\n\nFrage: Wohin geht die Klasse 3a?\n1) In die Bibliothek   2) Ins Schwimmbad   3) In den Zoo",
        ans: 2
    },
    {
        min: 5, max: 7,
        text: "üìñ Lesen (5.‚Äì6. Klasse)\n\nSara liebt B√ºcher √ºber Tiere. In der Bibliothek leiht sie ein Buch √ºber L√∂wen und eines √ºber Elefanten aus.\n\nFrage: Was leiht Sara aus?\n1) B√ºcher √ºber Autos   2) B√ºcher √ºber Tiere   3) B√ºcher √ºber Mathematik",
        ans: 2
    },
    {
        min: 5, max: 7,
        text: "üìñ Lesen (5.‚Äì6. Klasse)\n\nIn der Pause spielen die Kinder Fu√üball auf dem Pausenhof. Nach der Pause gehen alle wieder ins Klassenzimmer.\n\nFrage: Was machen die Kinder in der Pause?\n1) Sie schlafen im Klassenzimmer.\n2) Sie spielen Fu√üball auf dem Pausenhof.\n3) Sie fahren nach Hause.",
        ans: 2
    }
];

/* Schweiz / Kantone ‚Äì options style */
var chQuestions = [
    {
        min: 1, max: 4,
        question: "üèîÔ∏è Schweiz ‚Äì Kantone\n\nIn welchem Kanton liegt die Stadt Z√ºrich?",
        options: ["Z√ºrich", "Bern", "Tessin"],
        correctIndex: 0
    },
    {
        min: 3, max: 5,
        question: "üèîÔ∏è Schweiz ‚Äì Berge\n\nDas Matterhorn ist ein sehr bekannter Berg. In welchem Kanton liegt er?",
        options: ["Wallis", "Graub√ºnden", "Aargau"],
        correctIndex: 0
    },
    {
        min: 3, max: 5,
        question: "üèûÔ∏è Schweiz ‚Äì Seen\n\nDer Vierwaldst√§ttersee liegt in der Zentralschweiz.\nWelche Stadt liegt an diesem See?",
        options: ["Luzern", "Basel", "Genf"],
        correctIndex: 0
    },
    {
        min: 5, max: 7,
        question: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Schweiz ‚Äì Bev√∂lkerung\n\nWie viele Menschen leben ungef√§hr in der Schweiz?",
        options: ["ca. 2 Millionen", "ca. 9 Millionen", "ca. 50 Millionen"],
        correctIndex: 1
    },
    {
        min: 5, max: 7,
        question: "‚åö Schweiz ‚Äì Bekanntes\n\nWof√ºr ist die Schweiz besonders bekannt?",
        options: [
            "Uhren, Schokolade und Berge",
            "W√ºsten und Kamele",
            "Str√§nde am Meer"
        ],
        correctIndex: 0
    },
    {
        min: 5, max: 7,
        question: "üéø Schweiz ‚Äì Wintersport\n\nWelche Region ist als Wintersportort sehr bekannt?",
        options: ["St. Moritz", "Z√ºrich", "Lausanne"],
        correctIndex: 0
    }
];

/* Somalia & Geografie ‚Äì options style (NO ‚ÄûKenya Spain Brazil‚Äú combo) */
  var soQuestions = [
    {
        question: "üá∏üá¥ Somalia ‚Äì Taariikh\n\nGoorma ayay Soomaaliya xorowday (midowga Waqooyi & Koonfur)?",
        options: ["1960", "1970", "1985"],
        correctIndex: 0
    },
    {
        question: "üá∏üá¥ Somalia ‚Äì Madaxweyne\n\nKee ayaa muddo dheer madaxweyne ka ahaa Soomaaliya ilaa 1991?",
        options: ["Aden Cadde", "Siyaad Barre", "Sharmarke"],
        correctIndex: 1
    },
    {
        question: "üá∏üá¥ Somalia ‚Äì Gobollada\n\nIntee qiyaastii ah ayay gobollada Soomaaliya yihiin?",
        options: ["5 gobol", "10 gobol", "qiyaastii 18 gobol"],
        correctIndex: 2
    },
    {
        question: "üá∏üá¥ Somalia ‚Äì Gobollada\n\nGobolkee ayay magaalada Hargeysa ku taallaa?",
        options: ["Woqooyi Galbeed", "Banaadir", "Bay"],
        correctIndex: 0
    },
    {
        question: "üá∏üá¥ Somalia ‚Äì Gobollada\n\nGobolkee ayay magaalada Kismaayo ku taallaa?",
        options: ["Jubbada Hoose", "Galguduud", "Hiiraan"],
        correctIndex: 0
    },
    {
        question: "üèôÔ∏è Somalia ‚Äì Magaalooyin\n\nWaa kuwee caasimadda Soomaaliya?",
        options: ["Hargeysa", "Muqdisho", "Kismaayo"],
        correctIndex: 1
    },
    {
        question: "üèôÔ∏è Somalia ‚Äì Magaalooyin\n\nGaroowe waa magaalo muhiim ah oo xarun u ah‚Ä¶",
        options: ["Puntland", "Jubbaland", "Galmudug"],
        correctIndex: 0
    },
    {
        question: "üèûÔ∏è Somalia ‚Äì Webiyaal\n\nMid ka mid ah webiyada waaweyn ee Soomaaliya waa‚Ä¶",
        options: ["Rhein", "Shabeelle", "Amazonas"],
        correctIndex: 1
    },
    {
        question: "üåä Somalia ‚Äì Xeebaha\n\nSomalia waxay leedahay xeeb aad u dheer oo ku taal badda‚Ä¶",
        options: ["Caspian Sea", "Indian Ocean", "Baltic Sea"],
        correctIndex: 1
    },
    {
        question: "üåç Somalia ‚Äì Deris\n\nSomalia waxay deris la tahay Itoobiya iyo‚Ä¶",
        options: ["Kenya", "Japan", "Canada"],
        correctIndex: 0
    },
    {
        question: "üåç Somalia ‚Äì Qaaradda\n\nSomalia waxay ku taallaa qaaradda‚Ä¶",
        options: ["Afrika", "Aasiya", "Yurub"],
        correctIndex: 0
    },
    {
        question: "üí∞ Somalia ‚Äì Lacagta\n\nLacagta rasmiga ah ee Soomaaliya waa‚Ä¶",
        options: ["Shilin Soomaali", "Euro", "Shilingi Kenya"],
        correctIndex: 0
    },
    {
        question: "üó£Ô∏è Somalia ‚Äì Luuqadaha\n\nLuuqadaha rasmiga ah ee Soomaaliya waa‚Ä¶",
        options: [
            "Af-Soomaali & Carabi",
            "Af-Jarmal & Af-Faransiis",
            "Af-Taliyaani & Af-Maay"
        ],
        correctIndex: 0
    }
];

/* ---------- PROFILES & STORAGE ---------- */

function ensureModules(profile) {
    if (!profile.modules) profile.modules = {};
    if (!profile.levels) profile.levels = {};
    var keys = ["add","sub","mul","frac","de","read","en","fr","itbasics","flags","chgeo","soinfo"];
    keys.forEach(function(k){
        if (!profile.modules[k]) {
            profile.modules[k] = { correct: 0, total: 0 };
        }
        if (!profile.levels[k]) {
            profile.levels[k] = 1;
        }
    });
}

function loadProfiles() {
    try {
        var raw = localStorage.getItem(STORAGE_KEY);
        profiles = raw ? JSON.parse(raw) : [];
    } catch (e) {
        profiles = [];
    }
    profiles.forEach(ensureModules);
    renderProfileOptions();
    renderProfileButtons();
    renderHallOfFame();
}

function saveProfiles() {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(profiles));
    } catch (e) {
        console.log("LocalStorage Error:", e);
    }
}

function renderProfileOptions() {
    var sel = document.getElementById('profileSelect');
    sel.innerHTML = '<option value="">‚Äì Kind w√§hlen ‚Äì</option>';
    profiles.forEach(function(p) {
        var opt = document.createElement('option');
        opt.value = String(p.id);
        opt.textContent = p.name + " (Klasse " + (p.grade === "special" ? "6/7" : p.grade) + ")";
        sel.appendChild(opt);
    });

    if (activeProfileId !== null) {
        var found = profiles.find(function(p){ return p.id === activeProfileId; });
        if (found) {
            sel.value = String(activeProfileId);
        } else {
            activeProfileId = null;
            score = 0;
            updateScoreUI();
        }
    }
}

function renderProfileButtons() {
    var bar = document.getElementById('profileButtonsBar');
    if (!bar) return;
    bar.innerHTML = "";
    profiles.forEach(function(p){
        var btn = document.createElement('button');
        btn.textContent = p.name;
        if (p.id === activeProfileId) {
            btn.classList.add('active');
        }
        btn.onclick = function(){ selectProfileById(p.id, true); };
        bar.appendChild(btn);
    });
}

function addProfile() {
    if (profiles.length >= 10) {
        alert("Maximal 10 Kinder k√∂nnen registriert werden.");
        return;
    }
    var name = prompt("Name des Kindes eingeben:");
    if (!name) return;
    name = name.trim();
    if (!name) return;

    var grade = document.getElementById('gradeSelect').value || "1";
    var newProfile = {
        id: Date.now(),
        name: name,
        grade: grade,
        score: 0,
        modules: {},
        levels: {}
    };
    ensureModules(newProfile);
    profiles.push(newProfile);
    activeProfileId = newProfile.id;
    score = 0;
    saveProfiles();
    renderProfileOptions();
    renderProfileButtons();
    document.getElementById('profileSelect').value = String(newProfile.id);
    currentGrade = grade;
    document.getElementById('gradeSelect').value = grade;
    updateScoreUI();
    renderHallOfFame();
}

function resetActiveProfile() {
    var p = getActiveProfile();
    if (!p) {
        alert("Kein aktives Kind ausgew√§hlt.");
        return;
    }
    if (!confirm("Profil von " + p.name + " komplett zur√ºcksetzen (Punkte + Level)?")) {
        return;
    }
    p.score = 0;
    if (!p.modules) p.modules = {};
    if (!p.levels) p.levels = {};
    var keys = ["add","sub","mul","frac","de","read","en","fr","itbasics","flags","chgeo","soinfo"];
    keys.forEach(function(k){
        p.modules[k] = { correct: 0, total: 0 };
        p.levels[k] = 1;
    });
    score = 0;
    currentRun = { mode: currentMode, count: 0, correct: 0 };
    saveProfiles();
    updateScoreUI();
    renderHallOfFame();
    renderProfileButtons();
    var fb = document.getElementById('feedbackBox');
    if (fb) fb.innerText = "Profil wurde zur√ºckgesetzt.";
}

function selectProfile() {
    var sel = document.getElementById('profileSelect');
    var val = sel.value;
    if (!val) {
        activeProfileId = null;
        score = 0;
        updateScoreUI();
        renderHallOfFame();
        renderProfileButtons();
        return;
    }
    selectProfileById(Number(val), false);
}

function selectProfileById(id, scrollToTop) {
    var profile = profiles.find(function(p){ return p.id === id; });
    if (!profile) {
        activeProfileId = null;
        score = 0;
        updateScoreUI();
        renderHallOfFame();
        renderProfileButtons();
        return;
    }
    ensureModules(profile);
    activeProfileId = id;
    currentGrade = profile.grade || "1";
    document.getElementById('gradeSelect').value = currentGrade;
    score = profile.score || 0;
    updateScoreUI();

    var sel = document.getElementById('profileSelect');
    if (sel) sel.value = String(id);

    renderHallOfFame();
    renderProfileButtons();
    if (scrollToTop) {
        window.scrollTo({top:0, behavior:"smooth"});
    }
    if (currentMode !== null) {
        resetRunForMode(currentMode);
        newQuestion();
    }
}

function getActiveProfile() {
    if (activeProfileId === null) return null;
    return profiles.find(function(p){ return p.id === activeProfileId; }) || null;
}

function updateScoreUI() {
    document.getElementById('scoreBox').innerText = "Punkte: " + score;
}

/* ---------- HALL OF FAME + DIAGRAM + FEEDBACK ---------- */

function renderHallOfFame() {
    var container = document.getElementById('hallOfFame');
    if (!container) return;
    if (!profiles.length) {
        container.innerHTML = "<p>Noch keine Kinder registriert.</p>";
        return;
    }

    var sorted = profiles.slice().sort(function(a,b){
        return (b.score || 0) - (a.score || 0);
    });

    var html = "";
    sorted.forEach(function(p, idx){
        ensureModules(p);
        var m = p.modules;

        var matheCorr = m.add.correct + m.sub.correct + m.mul.correct + m.frac.correct;
        var matheTot  = m.add.total   + m.sub.total   + m.mul.total   + m.frac.total;
        var lesenCorr = m.read.correct + m.de.correct;
        var lesenTot  = m.read.total   + m.de.total;
        var sprCorr   = m.en.correct + m.fr.correct;
        var sprTot    = m.en.total   + m.fr.total;
        var wCorr     = m.itbasics.correct + m.flags.correct + m.chgeo.correct + m.soinfo.correct;
        var wTot      = m.itbasics.total   + m.flags.total   + m.chgeo.total   + m.soinfo.total;

        var mathePct = matheTot > 0 ? Math.round(matheCorr / matheTot * 100) : 0;
        var lesenPct = lesenTot > 0 ? Math.round(lesenCorr / lesenTot * 100) : 0;
        var sprPct   = sprTot   > 0 ? Math.round(sprCorr   / sprTot   * 100) : 0;
        var wPct     = wTot    > 0 ? Math.round(wCorr      / wTot     * 100) : 0;

        html += '<div class="hall-item">';
        html += (idx+1) + ". <b>" + escapeHtml(p.name) + "</b> (Klasse "
             + (p.grade === "special" ? "6/7" : p.grade)
             + ") ‚Äì Punkte: " + (p.score || 0);

        html += '<div class="hall-bars">';
        html += renderBarRow("Mathe", mathePct, "mathe");
        html += renderBarRow("Lesen", lesenPct, "lesen");
        html += renderBarRow("Sprachen", sprPct, "sprache");
        html += renderBarRow("Wissen", wPct, "wissen");
        html += '</div>';

        html += '<div class="hall-feedback">' +
                escapeHtml(buildFeedback(mathePct, lesenPct, sprPct, wPct)) +
                '</div>';

        html += '<div class="hall-testbutton"><button type="button" onclick="selectProfileById(' +
                p.id + ', true)">Test mit ' + escapeHtml(p.name) + '</button></div>';

        html += '</div>';
    });
    container.innerHTML = html;
}

function renderBarRow(label, pct, type) {
    var cl = "bar-row-bar-fill-";
    if (type === "mathe") cl += "mathe";
    else if (type === "lesen") cl += "lesen";
    else if (type === "sprache") cl += "sprache";
    else cl += "wissen";

    return '' +
        '<div class="bar-row">' +
            '<div class="bar-row-label">' + label + '</div>' +
            '<div class="bar-row-bar"><div class="bar-row-bar-fill ' + cl +
                '" style="width:' + pct + '%;"></div></div>' +
            '<div class="bar-row-pct">' + pct + '%</div>' +
        '</div>';
}

function buildFeedback(mathePct, lesenPct, sprPct, wPct) {
    var cats = [
        { key: "Mathe", pct: mathePct },
        { key: "Lesen", pct: lesenPct },
        { key: "Sprachen", pct: sprPct },
        { key: "Wissen (IT & L√§nder)", pct: wPct }
    ];
    var sum = mathePct + lesenPct + sprPct + wPct;
    if (sum === 0) {
        return "Noch keine Daten ‚Äì ein paar Aufgaben l√∂sen, dann gibt es pers√∂nliches Feedback.";
    }

    cats.sort(function(a,b){ return b.pct - a.pct; });
    var best = cats[0];
    var worst = cats[cats.length - 1];

    var text = "";

    if (best.pct >= 70) {
        text += "Sehr stark in " + best.key + ". ";
    } else if (best.pct >= 40) {
        text += "Gut unterwegs in " + best.key + ". ";
    } else {
        text += "Du bist noch am Aufbauen ‚Äì Schritt f√ºr Schritt in " + best.key + ". ";
    }

    if (worst.pct <= 30) {
        text += "In " + worst.key + " darfst du noch extra √ºben. ";
    } else if (worst.pct < best.pct) {
        text += worst.key + " ist ok, aber da geht noch mehr. ";
    }

    var mid = cats[1];
    if (mid && mid !== best && mid !== worst) {
        text += "In " + mid.key + " bist du auf einem guten Weg.";
    }

    return text.trim();
}

/* ---------- LEVEL HELPERS ---------- */

function getModeLabel(mode) {
    switch (mode) {
        case "add": return "Addition";
        case "sub": return "Subtraktion";
        case "mul": return "Multiplikation";
        case "frac": return "Br√ºche";
        case "de": return "Deutschaufgaben";
        case "read": return "Lesen";
        case "en": return "Englisch";
        case "fr": return "Franz√∂sisch";
        case "itbasics": return "Informatik";
        case "flags": return "Flaggen Afrika";
        case "chgeo": return "Schweiz";
        case "soinfo": return "Somalia";
        default: return "Modul";
    }
}

function getProfileLevel(profile, mode) {
    if (!profile || !profile.levels) return 1;
    return profile.levels[mode] || 1;
}

function setProfileLevel(profile, mode, level) {
    if (!profile.levels) profile.levels = {};
    profile.levels[mode] = level;
}

function resetRunForMode(mode) {
    currentRun = { mode: mode, count: 0, correct: 0 };
}

/* ---------- GENERAL UI ---------- */

function updateGrade() {
    var sel = document.getElementById('gradeSelect');
    currentGrade = sel.value;

    var p = getActiveProfile();
    if (p) {
        p.grade = currentGrade;
        saveProfiles();
        renderProfileOptions();
        renderProfileButtons();
        renderHallOfFame();
    }

    if (currentMode !== null) {
        resetRunForMode(currentMode);
        newQuestion();
    }
}

function toggleMenu() {
    var menu = document.getElementById('menuList');
    menu.style.display = (menu.style.display === "block") ? "none" : "block";
}

function toggleDarkMode() {
    var body = document.body;
    var toggle = document.getElementById('darkToggle');
    if (toggle.checked) {
        if (body.className.indexOf('dark-mode') === -1) {
            body.className += (body.className ? ' ' : '') + 'dark-mode';
        }
    } else {
        body.className = body.className.replace('dark-mode','').replace('  ',' ').trim();
    }
}

function chooseMode(mode) {
    currentMode = mode;
    resetRunForMode(mode);
    document.getElementById('gameArea').style.display = 'block';
    document.getElementById('feedbackBox').innerText = '';

    var p = getActiveProfile();
    if (!p) {
        document.getElementById('instructions').innerText =
          "Bitte zuerst ein Kind ausw√§hlen und dann das Spiel starten.";
    } else {
        var lvl = getProfileLevel(p, mode);
        document.getElementById('instructions').innerText =
          "Kind: " + p.name + " ¬∑ Klasse: " +
          (p.grade === "special" ? "6/7" : p.grade) +
          " ¬∑ Level " + lvl + " in " + getModeLabel(mode) +
          " (5 Fragen pro Level).";
    }

    newQuestion();
}

/* ---------- GRADE HELPERS ---------- */

function gradeNumber() {
    if (currentGrade === "special") return 7;
    var n = parseInt(currentGrade, 10);
    if (isNaN(n)) return 1;
    return n;
}

function getSettingsForGrade() {
    switch (currentGrade) {
        case "1": return { addMax: 10, subMax: 10, mulMax: 5 };
        case "2": return { addMax: 20, subMax: 20, mulMax: 8 };
        case "3": return { addMax: 30, subMax: 30, mulMax: 10 };
        case "4": return { addMax: 50, subMax: 50, mulMax: 10 };
        case "5": return { addMax: 80, subMax: 80, mulMax: 12 };
        case "6": return { addMax: 100, subMax: 100, mulMax: 12 };
        case "special": return { addMax: 150, subMax: 150, mulMax: 15 };
        default: return { addMax: 20, subMax: 20, mulMax: 10 };
    }
}

function getReadingPoolForGrade() {
    var g = gradeNumber();
    var pool = readQuestions.filter(function(q){
        return g >= q.min && g <= q.max;
    });
    return pool.length ? pool : readQuestions;
}

function getChPoolForGrade() {
    var g = gradeNumber();
    var pool = chQuestions.filter(function(q){
        return g >= q.min && g <= q.max;
    });
    return pool.length ? pool : chQuestions;
}

/* ---------- ANSWER RENDERING ---------- */

function setChoices(choices, answersClass) {
    var container = document.getElementById('answersContainer');
    container.className = "answers " + (answersClass || "");
    container.innerHTML = "";
    choices.forEach(function(c){
        var btn = document.createElement('button');
        btn.textContent = c.text;
        btn.onclick = function(){ handleChoice(c.value); };
        container.appendChild(btn);
    });
}

function setFlagChoices(correctCode, otherCodes) {
    var container = document.getElementById('answersContainer');
    container.className = "answers answers-flags";
    container.innerHTML = "";

    var codes = [correctCode].concat(otherCodes);
    for (var i = codes.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var tmp = codes[i]; codes[i] = codes[j]; codes[j] = tmp;
    }

    codes.forEach(function(code){
        var info = flagMap[code];
        if (!info) return;
        var btn = document.createElement('button');
        var img = document.createElement('img');
        img.src = info.url;
        img.alt = info.label;
        var span = document.createElement('span');
        span.textContent = info.label;
        btn.appendChild(img);
        btn.appendChild(span);
        btn.onclick = function(){ handleChoice(code); };
        container.appendChild(btn);
    });
}

/* ---------- QUESTION CREATION ---------- */

function makeNumericChoices(correct) {
    var vals = [correct];
    while (vals.length < 3) {
        var delta = randomInt(-5, 5);
        if (delta === 0) continue;
        var cand = correct + delta;
        if (cand <= 0) continue;
        if (vals.indexOf(cand) === -1) vals.push(cand);
    }
    for (var i = vals.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var tmp = vals[i]; vals[i] = vals[j]; vals[j] = tmp;
    }
    return vals.map(function(v){ return { value: v, text: String(v) }; });
}

function newQuestion() {
    var qBox = document.getElementById('questionBox');
    var title = document.getElementById('gameTitle');
    var inst = document.getElementById('instructions');
    var fb = document.getElementById('feedbackBox');
    fb.innerText = "";
    var answersDiv = document.getElementById('answersContainer');
    answersDiv.innerHTML = "";

    var settings = getSettingsForGrade();
    var p = getActiveProfile();

    if (!p) {
        title.innerText = "Spiel";
        qBox.innerText = "Bitte zuerst ein Kind ausw√§hlen.";
        inst.innerText = "W√§hle oben ein Kind, dann ein Spiel.";
        currentQuestion = null;
        return;
    }

    var a, b, q, corr;

    if (currentMode === 'add') {
        title.innerText = "Addition ‚Äì Zahlen-Training";
        a = randomInt(1, settings.addMax);
        b = randomInt(1, settings.addMax);
        corr = a + b;
        qBox.innerText = a + " + " + b + " = ?";
        currentQuestion = { correctValue: corr, mode: "add" };
        setChoices(makeNumericChoices(corr), "answers-math");
    } else if (currentMode === 'sub') {
        title.innerText = "Subtraktion ‚Äì Minus & Unterschiede";
        a = randomInt(1, settings.subMax);
        b = randomInt(1, a);
        corr = a - b;
        qBox.innerText = a + " ‚àí " + b + " = ?";
        currentQuestion = { correctValue: corr, mode: "sub" };
        setChoices(makeNumericChoices(corr), "answers-math");
    } else if (currentMode === 'mul') {
        title.innerText = "Multiplikation ‚Äì Mal-Spiel";
        a = randomInt(1, settings.mulMax);
        b = randomInt(1, settings.mulMax);
        corr = a * b;
        qBox.innerText = a + " √ó " + b + " = ?";
        currentQuestion = { correctValue: corr, mode: "mul" };
        setChoices(makeNumericChoices(corr), "answers-math");
    } else if (currentMode === 'frac') {
        title.innerText = "Br√ºche ‚Äì Teil vom Ganzen";
        var fracQuestions = [
            { text: "1/2 von 8 = ?", ans: 4 },
            { text: "1/3 von 9 = ?", ans: 3 },
            { text: "1/4 von 20 = ?", ans: 5 }
        ];
        q = fracQuestions[randomInt(0, fracQuestions.length - 1)];
        qBox.innerText = q.text;
        corr = q.ans;
        currentQuestion = { correctValue: corr, mode: "frac" };
        setChoices(makeNumericChoices(corr), "answers-math");
    } else if (currentMode === 'de') {
        title.innerText = "Deutschaufgabe ‚Äì Rechnen im Satz";
        a = randomInt(1, settings.addMax);
        b = randomInt(1, settings.addMax);
        corr = a + b;
        qBox.innerText =
            "Anna hat " + a + " √Ñpfel und bekommt noch " + b +
            " dazu.\nWie viele √Ñpfel hat Anna jetzt insgesamt?";
        currentQuestion = { correctValue: corr, mode: "de" };
        setChoices(makeNumericChoices(corr), "answers-math");
    } else if (currentMode === 'read') {
        title.innerText = "Lesen / Leseverstehen";
        var pool = getReadingPoolForGrade();
        q = pool[randomInt(0, pool.length - 1)];
        qBox.innerText = q.text;
        currentQuestion = { correctValue: q.ans, mode: "read" };
        setChoices(
            [
                { value: 1, text: "1" },
                { value: 2, text: "2" },
                { value: 3, text: "3" }
            ],
            "answers-read"
        );
    } else if (currentMode === 'en') {
        title.innerText = "Englisch ‚Äì W√∂rter & Farben";
        q = enQuestions[randomInt(0, enQuestions.length - 1)];
        qBox.innerText = "üá¨üáß Englisch\n" + q.question;
        currentQuestion = { correctValue: q.correctIndex, mode: "en" };
        var choices = q.options.map(function(opt, idx){
            return { value: idx, text: opt };
        });
        setChoices(choices, "answers-lang");
    } else if (currentMode === 'fr') {
        title.innerText = "Franz√∂sisch ‚Äì W√∂rter & Farben";
        q = frQuestions[randomInt(0, frQuestions.length - 1)];
        qBox.innerText = "üá´üá∑ Franz√∂sisch\n" + q.question;
        currentQuestion = { correctValue: q.correctIndex, mode: "fr" };
        var choicesFr = q.options.map(function(opt, idx){
            return { value: idx, text: opt };
        });
        setChoices(choicesFr, "answers-lang");
    } else if (currentMode === 'itbasics') {
        title.innerText = "Informatik Basics ‚Äì PC-Wissen";
        q = itBasicsQuestions[randomInt(0, itBasicsQuestions.length - 1)];
        qBox.innerText = "üíª Informatik\n" + q.question;
        currentQuestion = { correctValue: q.correctIndex, mode: "itbasics" };
        var choicesIt = q.options.map(function(opt, idx){
            return { value: idx, text: opt };
        });
        setChoices(choicesIt, "answers-it");
    } else if (currentMode === 'flags') {
        title.innerText = "Flaggen Afrika ‚Äì Calan & Waddan";
        q = flagQuestions[randomInt(0, flagQuestions.length - 1)];
        qBox.innerText = "üåç Waddan: " + q.country + "\n\nDooro calanka saxda ah:";
        currentQuestion = { correctValue: q.correct, hint: q.hint, mode: "flags" };
        setFlagChoices(q.correct, q.others);
    } else if (currentMode === 'chgeo') {
        title.innerText = "Schweiz & Kantone ‚Äì Geografie";
        var chPool = getChPoolForGrade();
        q = chPool[randomInt(0, chPool.length - 1)];
        qBox.innerText = q.question;
        currentQuestion = { correctValue: q.correctIndex, mode: "chgeo" };
        var chChoices = q.options.map(function(opt, idx){
            return { value: idx, text: opt };
        });
        setChoices(chChoices, "answers-geo");
    } else if (currentMode === 'soinfo') {
        title.innerText = "Somalia & Geografie ‚Äì Taariikh & Aqoon";
        q = soQuestions[randomInt(0, soQuestions.length - 1)];
        qBox.innerText = q.question;
        currentQuestion = { correctValue: q.correctIndex, mode: "soinfo" };
        var soChoices = q.options.map(function(opt, idx){
            return { value: idx, text: opt };
        });
        setChoices(soChoices, "answers-geo");
    } else {
        title.innerText = "Spiel";
        qBox.innerText = "W√§hle oben ein Spiel aus.";
        inst.innerText = "";
        currentQuestion = null;
    }
}

/* ---------- ANSWER HANDLING + LEVEL LOGIC ---------- */

function updateModuleStats(mode, isCorrect) {
    var p = getActiveProfile();
    if (!p) return;
    ensureModules(p);
    var m = p.modules[mode];
    if (!m) {
        m = { correct: 0, total: 0 };
        p.modules[mode] = m;
    }
    m.total++;
    if (isCorrect) m.correct++;
}

function handleChoice(selectedValue) {
    var fb = document.getElementById('feedbackBox');
    var p = getActiveProfile();
    if (!p || !currentQuestion) {
        fb.innerText = "Bitte zuerst ein Kind und ein Spiel ausw√§hlen.";
        fb.style.color = "orange";
        return;
    }

    var correct = currentQuestion.correctValue;
    var mode = currentMode;
    var isCorrect = (selectedValue === correct);

    if (!currentRun.mode || currentRun.mode !== mode) {
        resetRunForMode(mode);
    }

    if (mode === "flags" && currentQuestion.hint && isCorrect) {
        fb.innerText = "Richtig! üëè\n" + currentQuestion.hint;
    } else if (isCorrect) {
        fb.innerText = "Richtig! üëè";
    } else {
        fb.innerText = "Falsch. Versuch es noch einmal.";
    }
    fb.style.color = isCorrect ? "lightgreen" : "red";

    updateModuleStats(mode, isCorrect);

    /* Level-run update */
    currentRun.count++;
    if (isCorrect) currentRun.correct++;

    var extraMsg = "";

    if (currentRun.count >= 5) {
        ensureModules(p);
        var lvl = getProfileLevel(p, mode);
        if (currentRun.correct >= 4) {
            lvl++;
            setProfileLevel(p, mode, lvl);
            extraMsg = "\nLevel geschafft! Du bist jetzt Level " + lvl +
                       " in " + getModeLabel(mode) + ".";
        } else {
            extraMsg = "\nLevel nicht bestanden ‚Äì du bleibst auf Level " + lvl +
                       " in " + getModeLabel(mode) + ".";
        }
        fb.innerText += extraMsg;
        currentRun.count = 0;
        currentRun.correct = 0;
    }

    saveProfiles();
    renderHallOfFame();
    renderProfileButtons();

    if (isCorrect) {
        score++;
        p.score = score;
        updateScoreUI();
        setTimeout(newQuestion, mode === "flags" ? 1400 : 900);
    }
}

/* ---------- HELPERS ---------- */

function randomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function escapeHtml(str) {
    return String(str)
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
}

/* ---------- INIT ---------- */

loadProfiles();
updateScoreUI();
</script>

</body>
</html>
