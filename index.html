<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mathe & Deutsch â€“ Spielplatz (Musti)</title>

<style>
    :root {
        --bg: #84c0f0;
        --header-bg: #1b75d0;
        --text: #000000;
        --card-bg: #ffffff;
        --card-shadow: rgba(0,0,0,0.3);
        --accent: #0056a6;
        --score-bg: #1b75d0;
        --side-bg: #fffbcc;
        --button-ok: #28a745;
        --button-ok-hover: #218838;
        --menu-bg: #ffffff;
        --menu-hover: #e3f2ff;
        --input-border: #ccc;
    }

    body.dark-mode {
        --bg: #021626;
        --header-bg: #001133;
        --text: #f5f5f5;
        --card-bg: #0f2233;
        --card-shadow: rgba(0,0,0,0.8);
        --accent: #2296ff;
        --score-bg: #004080;
        --side-bg: #2d2a0f;
        --button-ok: #1c8c3a;
        --button-ok-hover: #0f6b2a;
        --menu-bg: #071521;
        --menu-hover: #123047;
        --input-border: #555;
    }

    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        text-align: center;
    }
    header {
        background: var(--header-bg);
        padding: 8px 12px;
        color: white;
        font-size: 20px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-sizing: border-box;
    }
    .header-center {
        flex: 1;
        text-align: center;
    }
    header small {
        display: block;
        font-size: 13px;
        margin-top: 4px;
        font-weight: normal;
    }
    .flag {
        width: 50px;
        text-align: center;
    }
    .flag img {
        height: 28px;
        border-radius: 4px;
        box-shadow: 0 0 4px rgba(0,0,0,0.4);
    }

    .top-bar {
        margin: 10px auto 0;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: center;
        align-items: center;
        font-size: 13px;
    }
    .top-bar input,
    .top-bar select,
    .top-bar button {
        padding: 6px 10px;
        border-radius: 10px;
        border: 1px solid var(--input-border);
        background: var(--card-bg);
        color: var(--text);
        font-size: 13px;
    }
    .top-bar button {
        cursor: pointer;
        border: none;
        background: var(--accent);
        color: #fff;
        font-weight: bold;
    }
    .top-bar button:hover {
        opacity: 0.9;
    }
    .top-label {
        font-weight: bold;
    }
    .score {
        font-weight: bold;
        color: #fff;
        background: var(--score-bg);
        padding: 4px 10px;
        border-radius: 10px;
        font-size: 13px;
    }
    .dark-toggle label {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 13px;
        cursor: pointer;
    }

    .menu-bar {
        margin: 15px auto 5px;
        max-width: 420px;
    }
    .hamburger-btn {
        width: 100%;
        padding: 10px 14px;
        border-radius: 12px;
        border: none;
        background: var(--accent);
        color: white;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        box-shadow: 0 3px 6px var(--card-shadow);
    }
    .hamburger-icon {
        font-size: 20px;
    }
    .menu-list {
        margin-top: 6px;
        display: none;
        background: var(--menu-bg);
        border-radius: 12px;
        box-shadow: 0 3px 8px var(--card-shadow);
        overflow: hidden;
    }
    .menu-item {
        width: 100%;
        padding: 10px 14px;
        border: none;
        background: transparent;
        cursor: pointer;
        text-align: left;
        font-size: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: var(--text);
    }
    .menu-item span {
        font-size: 18px;
        margin-right: 8px;
    }
    .menu-item small {
        font-size: 12px;
        opacity: 0.8;
    }
    .menu-item:hover {
        background: var(--menu-hover);
    }

    .game-area {
        max-width: 520px;
        margin: 15px auto 20px;
        background: var(--card-bg);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 10px var(--card-shadow);
        text-align: center;
    }
    .game-area h2 {
        margin-top: 0;
    }
    .question {
        font-size: 20px;
        margin: 10px 0;
        white-space: pre-line;
    }
    .hint {
        font-size: 13px;
        margin-bottom: 8px;
    }
    body.dark-mode .hint {
        color: #cccccc;
    }
    body:not(.dark-mode) .hint {
        color: #555555;
    }
    .game-area input {
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid var(--input-border);
        width: 200px;
        text-align: center;
        background: var(--card-bg);
        color: var(--text);
    }
    .game-area button {
        margin-top: 10px;
        padding: 10px 18px;
        background: var(--button-ok);
        border: none;
        border-radius: 10px;
        color: white;
        font-weight: bold;
        cursor: pointer;
    }
    .game-area button:hover {
        background: var(--button-ok-hover);
    }
    .feedback {
        margin-top: 10px;
        font-weight: bold;
    }

    .side-info {
        max-width: 650px;
        margin: 0 auto 30px;
        background: var(--side-bg);
        border-radius: 12px;
        padding: 10px 15px 15px;
        font-size: 14px;
        text-align: left;
        color: var(--text);
    }
    .side-info h3 {
        margin-top: 5px;
    }
    .side-info ul {
        padding-left: 20px;
        margin: 5px 0 10px;
    }
</style>
</head>
<body>

<header>
  <div class="flag">
    <img src="https://flagcdn.com/w40/so.png" alt="Somalia">
  </div>
  <div class="header-center">
    Mathe & Deutsch â€“ Spielplatz (Musti Edition)
    <small>Grundschule Â· Rechnen, Sprachen & Wissen lernen</small>
  </div>
  <div class="flag">
    <img src="https://flagcdn.com/w40/ch.png" alt="Schweiz">
  </div>
</header>

<div class="top-bar">
    <span class="top-label">Kind:</span>
    <select id="profileSelect" onchange="selectProfile()">
        <option value="">â€“ Kind wÃ¤hlen â€“</option>
    </select>
    <button type="button" onclick="addProfile()">Neues Kind</button>

    <span class="top-label">Klasse:</span>
    <select id="gradeSelect" onchange="updateGrade()">
        <option value="1">1. Klasse</option>
        <option value="2">2. Klasse</option>
        <option value="3">3. Klasse</option>
        <option value="4">4. Klasse</option>
        <option value="5">5. Klasse</option>
        <option value="6">6. Klasse</option>
        <option value="special">Spezial 6/7</option>
    </select>

    <span class="score" id="scoreBox">Punkte: 0</span>

    <div class="dark-toggle">
        <label>
            <input type="checkbox" id="darkToggle" onchange="toggleDarkMode()">
            ğŸŒ™ Dark Mode
        </label>
    </div>
</div>

<div class="menu-bar">
    <button class="hamburger-btn" onclick="toggleMenu()">
        <span class="hamburger-icon">â˜°</span>
        Spiele wÃ¤hlen (Mathe / Sprachen / Wissen)
    </button>
    <div class="menu-list" id="menuList">
        <button class="menu-item" onclick="chooseMode('add')">
            <span>â•</span> Addition <small>Einfache Plus-Aufgaben</small>
        </button>
        <button class="menu-item" onclick="chooseMode('sub')">
            <span>â–</span> Subtraktion <small>Minus & Unterschiede</small>
        </button>
        <button class="menu-item" onclick="chooseMode('mul')">
            <span>âœ–ï¸</span> Multiplikation <small>Mal-Rechnen</small>
        </button>
        <button class="menu-item" onclick="chooseMode('frac')">
            <span>ğŸ§©</span> BrÃ¼che <small>Teile vom Ganzen</small>
        </button>
        <button class="menu-item" onclick="chooseMode('de')">
            <span>ğŸ‡©ğŸ‡ª</span> Deutschaufgaben <small>â€Wie viel istâ€¦â€œ SÃ¤tze</small>
        </button>
        <button class="menu-item" onclick="chooseMode('read')">
            <span>ğŸ“–</span> Lesen / Leseverstehen <small>Text + Frage (1â€“3)</small>
        </button>
        <button class="menu-item" onclick="chooseMode('en')">
            <span>ğŸ‡¬ğŸ‡§</span> Englisch <small>WÃ¶rter & Farben (1â€“3)</small>
        </button>
        <button class="menu-item" onclick="chooseMode('fr')">
            <span>ğŸ‡«ğŸ‡·</span> FranzÃ¶sisch <small>WÃ¶rter & Farben (1â€“3)</small>
        </button>
        <button class="menu-item" onclick="chooseMode('itbasics')">
            <span>ğŸ’»</span> Informatik Basics <small>PC, Maus, Tastatur, Outlook</small>
        </button>
        <button class="menu-item" onclick="chooseMode('flags')">
            <span>ğŸŒ</span> Flaggen Afrika <small>Calan + Waddan (1â€“3)</small>
        </button>
    </div>
</div>

<div class="game-area" id="gameArea" style="display:none;">
    <h2 id="gameTitle">Spiel</h2>
    <p class="hint" id="instructions">
      WÃ¤hle oben ein Spiel und ein Kind aus.
    </p>
    <div class="question" id="questionBox">Frage</div>
    <input type="text" id="answerInput" placeholder="Antwort (meist Zahl)" />
    <br>
    <button onclick="checkAnswer()">OK</button>
    <div class="feedback" id="feedbackBox"></div>
</div>

<div class="side-info">
    <h3>Profile & Klassen</h3>
    <ul>
        <li>Maximal 10 Kinder kÃ¶nnen sich registrieren (Profile).</li>
        <li>Jedes Kind hat:
            <ul>
                <li>seinen eigenen Namen,</li>
                <li>seine eigene Klasse (1â€“6 oder Spezial 6/7),</li>
                <li>seine eigenen Punkte (Score) â€“ werden im Browser gespeichert.</li>
            </ul>
        </li>
        <li>Beim Wechsel des Kindes siehst du die Punkte von genau diesem Kind.</li>
    </ul>

    <h3>Module</h3>
    <ul>
        <li><b>Mathe:</b> Addition, Subtraktion, Multiplikation, BrÃ¼che â€“ reine Zahlenaufgaben.</li>
        <li><b>Deutsch:</b> Rechnen im ganzen Satz (â€Anna hat â€¦ Ã„pfelâ€œ).</li>
        <li><b>Lesen / Leseverstehen:</b> kurzer Text + Frage mit 1, 2 oder 3.</li>
        <li><b>Englisch & FranzÃ¶sisch:</b> WÃ¶rter & Farben â€“ Antwort 1, 2 oder 3.</li>
        <li><b>Informatik Basics:</b> PC, Maus, Tastatur, Outlook, Passwort-Sicherheit.</li>
        <li><b>Flaggen Afrika:</b> Calan + Waddan, mit EselsbrÃ¼cke (Darstellung zum Merken).</li>
    </ul>
</div>

<script>
/* ---------- GLOBAL STATE / PROFILES ---------- */
var currentMode = null;
var currentAnswer = null;
var score = 0;
var currentGrade = "1";
var profiles = [];
var activeProfileId = null;
var STORAGE_KEY = "musti_playground_profiles_v1";

/* ---------- QUESTION POOLS ---------- */

// Englisch
var enQuestions = [
    { text: "ğŸ‡¬ğŸ‡§ Englisch\nWÃ¤hle das richtige Wort.\n\nâ€Hundâ€œ auf Englisch?\n1) dog   2) cat   3) bird", ans: 1 },
    { text: "ğŸ‡¬ğŸ‡§ Englisch\nWÃ¤hle das richtige Wort.\n\nâ€Katzeâ€œ auf Englisch?\n1) dog   2) cat   3) mouse", ans: 2 },
    { text: "ğŸ‡¬ğŸ‡§ Englisch\nFarben.\n\nâ€rotâ€œ auf Englisch?\n1) red   2) blue   3) green", ans: 1 },
    { text: "ğŸ‡¬ğŸ‡§ Englisch\nFarben.\n\nâ€blauâ€œ auf Englisch?\n1) yellow   2) blue   3) black", ans: 2 },
    { text: "ğŸ‡¬ğŸ‡§ Englisch\nGegenstÃ¤nde.\n\nâ€Hausâ€œ auf Englisch?\n1) house   2) car   3) tree", ans: 1 }
];

// FranzÃ¶sisch
var frQuestions = [
    { text: "ğŸ‡«ğŸ‡· FranzÃ¶sisch\nWÃ¤hle das richtige Wort.\n\nâ€Hundâ€œ auf FranzÃ¶sich?\n1) chien   2) chat   3) oiseau", ans: 1 },
    { text: "ğŸ‡«ğŸ‡· FranzÃ¶sisch\nWÃ¤hle das richtige Wort.\n\nâ€Katzeâ€œ auf FranzÃ¶sisch?\n1) chien   2) chat   3) souris", ans: 2 },
    { text: "ğŸ‡«ğŸ‡· FranzÃ¶sisch\nFarben.\n\nâ€rotâ€œ auf FranzÃ¶sisch?\n1) rouge   2) bleu   3) vert", ans: 1 },
    { text: "ğŸ‡«ğŸ‡· FranzÃ¶sisch\nFarben.\n\nâ€blauâ€œ auf FranzÃ¶sisch?\n1) rouge   2) bleu   3) noir", ans: 2 },
    { text: "ğŸ‡«ğŸ‡· FranzÃ¶sisch\nGegenstÃ¤nde.\n\nâ€Hausâ€œ auf FranzÃ¶sisch?\n1) maison   2) voiture   3) arbre", ans: 1 }
];

// Informatik Basics
var itBasicsQuestions = [
    { text: "ğŸ’» Informatik Basics\n\nWelches GerÃ¤t ist hier gemeint?\n1) Computer / Laptop   2) Maus   3) Tastatur", ans: 1 },
    { text: "ğŸ–±ï¸ Informatik Basics\n\nDas kleine GerÃ¤t in der Hand zum Klicken.\nWas ist das?\n1) Bildschirm   2) Maus   3) Drucker", ans: 2 },
    { text: "âŒ¨ï¸ Informatik Basics\n\nDamit tippst du Buchstaben und Zahlen.\nWas ist das?\n1) Lautsprecher   2) Tastatur   3) Kabel", ans: 2 },
    { text: "ğŸ“§ Outlook\n\nWofÃ¼r benutzt man Outlook meistens?\n1) E-Mails   2) Spiele   3) Musik", ans: 1 },
    { text: "ğŸ” Passwort-Sicherheit\n\nWas ist ein gutes Passwort?\n1) nur Name   2) lang & gemischt   3) nur 1234", ans: 2 }
];

// Flaggen Afrika
var flagQuestions = [
    {
        flag: "ğŸ‡¸ğŸ‡´",
        options: ["Soomaaliya", "Kenia", "Ã„thiopien"],
        ans: 1,
        hint: "EselsbrÃ¼cke: Soomaaliya ğŸ‡¸ğŸ‡´ = buluug (bad & cirka) + xiddig cad oo dhexe kaga taal."
    },
    {
        flag: "ğŸ‡°ğŸ‡ª",
        options: ["Ghana", "Kenia", "Nigeria"],
        ans: 2,
        hint: "EselsbrÃ¼cke: Kenia ğŸ‡°ğŸ‡ª â€“ calanka leh gaashaan madow oo dhexe yaal, sida geesi ilaalinaya duurka."
    },
    {
        flag: "ğŸ‡ªğŸ‡¹",
        options: ["Ã„thiopien", "SÃ¼dafrika", "Soomaaliya"],
        ans: 1,
        hint: "EselsbrÃ¼cke: Ã„thiopien ğŸ‡ªğŸ‡¹ â€“ cagaar-jaalle-cas + xiddig dhexda, calan taariikhi ah."
    },
    {
        flag: "ğŸ‡³ğŸ‡¬",
        options: ["Nigeria", "Ghana", "SÃ¼dafrika"],
        ans: 1,
        hint: "EselsbrÃ¼cke: Nigeria ğŸ‡³ğŸ‡¬ â€“ cagaar-cad-cagaar, sida labo geed cagaaran iyo wabiga dhexda maraya."
    },
    {
        flag: "ğŸ‡¿ğŸ‡¦",
        options: ["Kenia", "SÃ¼dafrika", "Nigeria"],
        ans: 2,
        hint: "EselsbrÃ¼cke: SÃ¼dafrika ğŸ‡¿ğŸ‡¦ â€“ midabyo badan + xaraf Y, waddooyin badan oo isku yimaada."
    }
];

// Lesen / Leseverstehen â€“ minGrade, maxGrade
var readQuestions = [
    {
        min: 1, max: 2,
        text: "ğŸ“– Lesen (1.â€“2. Klasse)\n\nTom hat einen roten Ball. Er spielt im Garten.\n\nFrage: Wo spielt Tom?\n1) In der Schule   2) Im Garten   3) Im Auto",
        ans: 2
    },
    {
        min: 1, max: 2,
        text: "ğŸ“– Lesen (1.â€“2. Klasse)\n\nLina hat 3 BÃ¼cher. Sie liest gern im Bett.\n\nFrage: Wo liest Lina?\n1) Im Bett   2) Auf dem Spielplatz   3) Im Bus",
        ans: 1
    },
    {
        min: 3, max: 4,
        text: "ğŸ“– Lesen (3.â€“4. Klasse)\n\nMax fÃ¤hrt mit dem Bus zur Schule. Der Bus braucht 15 Minuten.\n\nFrage: Womit fÃ¤hrt Max zur Schule?\n1) Mit dem Auto   2) Mit dem Bus   3) Zu FuÃŸ",
        ans: 2
    },
    {
        min: 3, max: 4,
        text: "ğŸ“– Lesen (3.â€“4. Klasse)\n\nIm Sommer geht die Klasse 3a ins Schwimmbad. Alle bringen HandtÃ¼cher und Badehosen mit.\n\nFrage: Wohin geht die Klasse 3a?\n1) In die Bibliothek   2) Ins Schwimmbad   3) In den Zoo",
        ans: 2
    },
    {
        min: 5, max: 7,
        text: "ğŸ“– Lesen (5.â€“6. Klasse)\n\nSara liebt BÃ¼cher Ã¼ber Tiere. In der Bibliothek leiht sie ein Buch Ã¼ber LÃ¶wen und eines Ã¼ber Elefanten aus.\n\nFrage: Was leiht Sara aus?\n1) BÃ¼cher Ã¼ber Autos   2) BÃ¼cher Ã¼ber Tiere   3) BÃ¼cher Ã¼ber Mathematik",
        ans: 2
    },
    {
        min: 5, max: 7,
        text: "ğŸ“– Lesen (5.â€“6. Klasse)\n\nIn der Pause spielen die Kinder FuÃŸball auf dem Pausenhof. Nach der Pause gehen alle wieder ins Klassenzimmer.\n\nFrage: Was machen die Kinder in der Pause?\n1) Sie schlafen im Klassenzimmer.\n2) Sie spielen FuÃŸball auf dem Pausenhof.\n3) Sie fahren nach Hause.",
        ans: 2
    }
];

/* ---------- PROFILES + LOCALSTORAGE ---------- */

function loadProfiles() {
    try {
        var raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
            profiles = [];
        } else {
            profiles = JSON.parse(raw) || [];
        }
    } catch (e) {
        profiles = [];
    }
    renderProfileOptions();
}

function saveProfiles() {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(profiles));
    } catch (e) {
        console.log("LocalStorage Error:", e);
    }
}

function renderProfileOptions() {
    var sel = document.getElementById('profileSelect');
    sel.innerHTML = '<option value="">â€“ Kind wÃ¤hlen â€“</option>';
    profiles.forEach(function(p) {
        var opt = document.createElement('option');
        opt.value = String(p.id);
        opt.textContent = p.name + " (Klasse " + (p.grade === "special" ? "6/7" : p.grade) + ")";
        sel.appendChild(opt);
    });

    // Mark active if still in list
    if (activeProfileId !== null) {
        var found = profiles.find(function(p){ return p.id === activeProfileId; });
        if (found) {
            sel.value = String(activeProfileId);
        } else {
            activeProfileId = null;
            score = 0;
            updateScoreUI();
        }
    }
}

function addProfile() {
    if (profiles.length >= 10) {
        alert("Maximal 10 Kinder kÃ¶nnen registriert werden.");
        return;
    }
    var name = prompt("Name des Kindes eingeben:");
    if (!name) return;
    name = name.trim();
    if (name === "") return;

    var grade = document.getElementById('gradeSelect').value || "1";
    var newProfile = {
        id: Date.now(), // simple unique id
        name: name,
        grade: grade,
        score: 0
    };
    profiles.push(newProfile);
    activeProfileId = newProfile.id;
    score = 0;
    saveProfiles();
    renderProfileOptions();
    document.getElementById('profileSelect').value = String(newProfile.id);
    updateGradeFromProfile();
    updateScoreUI();
}

function selectProfile() {
    var sel = document.getElementById('profileSelect');
    var val = sel.value;
    if (!val) {
        activeProfileId = null;
        score = 0;
        updateScoreUI();
        return;
    }
    var id = Number(val);
    var profile = profiles.find(function(p){ return p.id === id; });
    if (!profile) {
        activeProfileId = null;
        score = 0;
        updateScoreUI();
        return;
    }
    activeProfileId = id;
    currentGrade = profile.grade || "1";
    document.getElementById('gradeSelect').value = currentGrade;
    score = profile.score || 0;
    updateScoreUI();
}

function getActiveProfile() {
    if (activeProfileId === null) return null;
    return profiles.find(function(p){ return p.id === activeProfileId; }) || null;
}

function updateScoreUI() {
    document.getElementById('scoreBox').innerText = "Punkte: " + score;
}

/* ---------- GENERAL UI ---------- */

function updateGrade() {
    var sel = document.getElementById('gradeSelect');
    currentGrade = sel.value;

    // Update in active profile
    var p = getActiveProfile();
    if (p) {
        p.grade = currentGrade;
        saveProfiles();
        renderProfileOptions(); // update text "(Klasse ...)"
    }

    if (currentMode !== null) {
        newQuestion();
    }
}

function toggleMenu() {
    var menu = document.getElementById('menuList');
    if (menu.style.display === "block") {
        menu.style.display = "none";
    } else {
        menu.style.display = "block";
    }
}

function toggleDarkMode() {
    var body = document.body;
    var toggle = document.getElementById('darkToggle');
    if (toggle.checked) {
        if (body.className.indexOf('dark-mode') === -1) {
            body.className += (body.className ? ' ' : '') + 'dark-mode';
        }
    } else {
        body.className = body.className.replace('dark-mode','').replace('  ',' ').trim();
    }
}

function chooseMode(mode) {
    currentMode = mode;
    document.getElementById('gameArea').style.display = 'block';
    document.getElementById('feedbackBox').innerText = '';

    var p = getActiveProfile();
    if (!p) {
        document.getElementById('instructions').innerText =
          "Bitte zuerst ein Kind auswÃ¤hlen und dann das Spiel starten.";
    } else {
        document.getElementById('instructions').innerText =
          "Kind: " + p.name + " Â· Klasse: " +
          (p.grade === "special" ? "6/7" : p.grade) +
          ". Aufgabe lÃ¶sen und nur die Zahl eingeben.";
    }

    newQuestion();
}

/* ---------- QUESTION GENERATION ---------- */

function gradeNumber() {
    if (currentGrade === "special") return 7;
    var n = parseInt(currentGrade, 10);
    if (isNaN(n)) return 1;
    return n;
}

function getSettingsForGrade() {
    switch (currentGrade) {
        case "1": return { addMax: 10, subMax: 10, mulMax: 5 };
        case "2": return { addMax: 20, subMax: 20, mulMax: 8 };
        case "3": return { addMax: 30, subMax: 30, mulMax: 10 };
        case "4": return { addMax: 50, subMax: 50, mulMax: 10 };
        case "5": return { addMax: 80, subMax: 80, mulMax: 12 };
        case "6": return { addMax: 100, subMax: 100, mulMax: 12 };
        case "special": return { addMax: 150, subMax: 150, mulMax: 15 };
        default: return { addMax: 20, subMax: 20, mulMax: 10 };
    }
}

function getReadingPoolForGrade() {
    var g = gradeNumber();
    var pool = readQuestions.filter(function(q){
        return g >= q.min && g <= q.max;
    });
    if (pool.length === 0) return readQuestions;
    return pool;
}

function newQuestion() {
    var qBox = document.getElementById('questionBox');
    var title = document.getElementById('gameTitle');
    var inst = document.getElementById('instructions');
    var input = document.getElementById('answerInput');
    var settings = getSettingsForGrade();
    var p = getActiveProfile();

    input.value = '';
    input.focus();

    var a, b, q;

    if (!p) {
        title.innerText = "Spiel";
        qBox.innerText = "Bitte zuerst ein Kind auswÃ¤hlen.";
        inst.innerText = "WÃ¤hle oben ein Kind, dann ein Spiel.";
        currentAnswer = null;
        return;
    }

    if (currentMode === 'add') {
        title.innerText = "Addition â€“ Zahlen-Training";
        inst.innerText = "Rechne die Plus-Aufgabe. Antworte mit einer Zahl (z.B. 12).";
        a = randomInt(1, settings.addMax);
        b = randomInt(1, settings.addMax);
        qBox.innerText = a + " + " + b + " = ?";
        currentAnswer = a + b;
    } else if (currentMode === 'sub') {
        title.innerText = "Subtraktion â€“ Minus & Unterschiede";
        inst.innerText = "Rechne die Minus-Aufgabe. Antworte mit einer Zahl.";
        a = randomInt(1, settings.subMax);
        b = randomInt(1, a);
        qBox.innerText = a + " âˆ’ " + b + " = ?";
        currentAnswer = a - b;
    } else if (currentMode === 'mul') {
        title.innerText = "Multiplikation â€“ Mal-Spiel";
        inst.innerText = "Mal-Aufgabe lÃ¶sen. Antworte mit einer Zahl.";
        a = randomInt(1, settings.mulMax);
        b = randomInt(1, settings.mulMax);
        qBox.innerText = a + " Ã— " + b + " = ?";
        currentAnswer = a * b;
    } else if (currentMode === 'frac') {
        title.innerText = "BrÃ¼che â€“ Teil vom Ganzen";
        inst.innerText = "Berechne den Anteil. Antworte mit einer Zahl.";
        var fracQuestions = [
            { text: "1/2 von 8 = ?", ans: 4 },
            { text: "1/3 von 9 = ?", ans: 3 },
            { text: "1/4 von 20 = ?", ans: 5 }
        ];
        q = fracQuestions[randomInt(0, fracQuestions.length - 1)];
        qBox.innerText = q.text;
        currentAnswer = q.ans;
    } else if (currentMode === 'de') {
        title.innerText = "Deutschaufgabe â€“ Rechnen im Satz";
        inst.innerText = "Lies den Satz genau und schreibe nur die Zahl als Antwort.";
        a = randomInt(1, settings.addMax);
        b = randomInt(1, settings.addMax);
        qBox.innerText =
            "Anna hat " + a + " Ã„pfel und bekommt noch " + b +
            " dazu.\nWie viele Ã„pfel hat Anna jetzt insgesamt?";
        currentAnswer = a + b;
    } else if (currentMode === 'read') {
        title.innerText = "Lesen / Leseverstehen";
        inst.innerText = "Lies den Text und wÃ¤hle 1, 2 oder 3. Schreibe nur die Zahl.";
        var pool = getReadingPoolForGrade();
        q = pool[randomInt(0, pool.length - 1)];
        qBox.innerText = q.text;
        currentAnswer = q.ans;
    } else if (currentMode === 'en') {
        title.innerText = "Englisch â€“ WÃ¶rter & Farben";
        inst.innerText = "WÃ¤hle 1, 2 oder 3. Schreibe nur die Zahl.";
        q = enQuestions[randomInt(0, enQuestions.length - 1)];
        qBox.innerText = q.text;
        currentAnswer = q.ans;
    } else if (currentMode === 'fr') {
        title.innerText = "FranzÃ¶sisch â€“ WÃ¶rter & Farben";
        inst.innerText = "WÃ¤hle 1, 2 oder 3. Schreibe nur die Zahl.";
        q = frQuestions[randomInt(0, frQuestions.length - 1)];
        qBox.innerText = q.text;
        currentAnswer = q.ans;
    } else if (currentMode === 'itbasics') {
        title.innerText = "Informatik Basics â€“ PC-Wissen";
        inst.innerText = "Lies die Beschreibung und wÃ¤hle 1, 2 oder 3 (nur Zahl).";
        q = itBasicsQuestions[randomInt(0, itBasicsQuestions.length - 1)];
        qBox.innerText = q.text;
        currentAnswer = q.ans;
    } else if (currentMode === 'flags') {
        title.innerText = "Flaggen Afrika â€“ Calan & Waddan";
        inst.innerText = "Eeg calanka, akhri suâ€™aasha Af-Soomaali, kadib dooro 1, 2 ama 3.";
        q = flagQuestions[randomInt(0, flagQuestions.length - 1)];
        var text =
            q.flag + "\n\nCalankani waxa iska leh kee?\n" +
            "1) " + q.options[0] + "\n" +
            "2) " + q.options[1] + "\n" +
            "3) " + q.options[2];
        qBox.innerText = text;
        currentAnswer = { val: q.ans, hint: q.hint };
    } else {
        title.innerText = "Spiel";
        qBox.innerText = "WÃ¤hle oben ein Spiel aus.";
        inst.innerText = "";
        currentAnswer = null;
    }
}

/* ---------- ANSWER CHECK ---------- */

function checkAnswer() {
    if (currentAnswer === null) {
        return;
    }
    var fb = document.getElementById('feedbackBox');
    var p = getActiveProfile();
    if (!p) {
        fb.innerText = "Bitte zuerst ein Kind auswÃ¤hlen.";
        fb.style.color = "orange";
        return;
    }

    var val = document.getElementById('answerInput').value.trim();
    if (val === "") {
        fb.innerText = "Bitte gib zuerst eine Antwort ein.";
        fb.style.color = "orange";
        return;
    }

    var userNum = Number(val);

    // Flaggen â€“ object {val, hint}
    if (currentMode === 'flags' && typeof currentAnswer === 'object') {
        if (userNum === currentAnswer.val) {
            fb.innerText = "Richtig! ğŸ‘\n" + currentAnswer.hint;
            fb.style.color = "lightgreen";
            score++;
            p.score = score;
            saveProfiles();
            updateScoreUI();
            setTimeout(newQuestion, 1300);
        } else {
            fb.innerText = "Falsch. Versuch es noch einmal.";
            fb.style.color = "red";
        }
        return;
    }

    if (userNum === currentAnswer) {
        fb.innerText = "Richtig! ğŸ‘";
        fb.style.color = "lightgreen";
        score++;
        p.score = score;
        saveProfiles();
        updateScoreUI();
        setTimeout(newQuestion, 900);
    } else {
        fb.innerText = "Falsch. Versuch es noch einmal.";
        fb.style.color = "red";
    }
}

/* ---------- HELPERS ---------- */

function randomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

/* ---------- INIT ---------- */

function updateName() {
    // Optional: title by name â€“ disabled for now, profiles already handle names
    // Haddii aad rabto mar dambe, waan ku celin karnaa.
}

function updateGradeFromProfile() {
    var p = getActiveProfile();
    if (!p) return;
    document.getElementById('gradeSelect').value = p.grade || "1";
}

loadProfiles();
updateScoreUI();
</script>

</body>
</html>
